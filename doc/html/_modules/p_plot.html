

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>p_plot &mdash; call-time-model  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/p_theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> call-time-model
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../config_files.html">Config Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">call-time-model</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>p_plot</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for p_plot</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Various functions for plotting model properties and results, as well as recorded data. [call-time-model]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">savgol_filter</span>
<span class="kn">import</span> <span class="nn">brian2</span> <span class="k">as</span> <span class="nn">b2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>

<span class="c1"># import my functions</span>
<span class="kn">import</span> <span class="nn">fcn.p_util</span>
<span class="kn">from</span> <span class="nn">fcn</span> <span class="kn">import</span> <span class="n">p_analysis</span><span class="p">,</span> <span class="n">p_util</span>

<span class="c1"># color palette adapted from http://mkweb.bcgsc.ca/biovis2012/ (colorblind-friendly)</span>
<span class="n">C_COLORS</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.427</span><span class="p">,</span> <span class="mf">0.859</span><span class="p">],</span>  <span class="c1"># 0 blue</span>
            <span class="p">[</span><span class="mf">0.859</span><span class="p">,</span> <span class="mf">0.427</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">],</span>  <span class="c1"># 1 orange</span>
            <span class="p">[</span><span class="mf">0.714</span><span class="p">,</span> <span class="mf">0.427</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">],</span>  <span class="c1"># 2 grape</span>
            <span class="p">[</span><span class="mf">0.573</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">],</span>  <span class="c1"># 3 red</span>
            <span class="p">[</span><span class="mf">0.845</span><span class="p">,</span> <span class="mf">0.798</span><span class="p">,</span> <span class="mf">0.171</span><span class="p">],</span>  <span class="c1"># 4 yellow</span>
            <span class="p">[</span><span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.286</span><span class="p">,</span> <span class="mf">0.286</span><span class="p">],</span>  <span class="c1"># 5 teal</span>
            <span class="p">[</span><span class="mf">0.286</span><span class="p">,</span> <span class="mf">0.000</span><span class="p">,</span> <span class="mf">0.573</span><span class="p">],</span>  <span class="c1"># 6 purple</span>
            <span class="p">[</span><span class="mf">0.000</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">]]</span>  <span class="c1"># -1 black</span>
<span class="n">C_COLORS_LIGHT</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.200</span><span class="p">,</span> <span class="mf">0.627</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">],</span>  <span class="c1"># 0 blue</span>
                  <span class="p">[</span><span class="mf">1.000</span><span class="p">,</span> <span class="mf">0.627</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">],</span>  <span class="c1"># 1 orange</span>
                  <span class="p">[</span><span class="mf">0.914</span><span class="p">,</span> <span class="mf">0.627</span><span class="p">,</span> <span class="mf">1.000</span><span class="p">],</span>  <span class="c1"># 2 grape</span>
                  <span class="p">[</span><span class="mf">0.773</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">],</span>  <span class="c1"># 3 red</span>
                  <span class="p">[</span><span class="mf">0.945</span><span class="p">,</span> <span class="mf">0.898</span><span class="p">,</span> <span class="mf">0.271</span><span class="p">],</span>  <span class="c1"># 4 yellow</span>
                  <span class="p">[</span><span class="mf">0.200</span><span class="p">,</span> <span class="mf">0.486</span><span class="p">,</span> <span class="mf">0.486</span><span class="p">],</span>  <span class="c1"># 5 teal</span>
                  <span class="p">[</span><span class="mf">0.486</span><span class="p">,</span> <span class="mf">0.200</span><span class="p">,</span> <span class="mf">0.773</span><span class="p">],</span>  <span class="c1"># 6 purple</span>
                  <span class="p">[</span><span class="mf">0.000</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">,</span>   <span class="mf">0.0</span><span class="p">]]</span>  <span class="c1"># -1 black</span>
<span class="n">C_COLORS_GREY</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>  <span class="c1"># 0 black</span>
                 <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]]</span>  <span class="c1"># 10 white</span>
<span class="n">CMAP_NAME_CONTINUOUS</span> <span class="o">=</span> <span class="s1">&#39;viridis&#39;</span>


<div class="viewcode-block" id="get_color_list"><a class="viewcode-back" href="../p_plot.html#p_plot.get_color_list">[docs]</a><span class="k">def</span> <span class="nf">get_color_list</span><span class="p">(</span><span class="n">n_colors</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">i_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a list of 3-element lists containing RGB values (0-1) of n_colors length</span>

<span class="sd">    :param n_colors: number of list entries (colors) needed</span>
<span class="sd">    :type n_colors: int</span>
<span class="sd">    :param color_map_in: [default=None] color map (list of 3-element lists) that should be repeated to get n_colors</span>
<span class="sd">    :type color_map_in: [[float, float, float]] or None</span>
<span class="sd">    :param i_colors: [default=None] list of indices to colors of the colormap (i.e. order of colors) of length n_colors</span>
<span class="sd">    :type i_colors: list or None</span>
<span class="sd">    :return: color_map_out: list of 3-element lists containing RGB values (0-1) of (at least) n_colors length</span>
<span class="sd">    :rtype: [[float, float, float]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">color_map_in</span><span class="p">:</span>
        <span class="c1"># use default color map</span>
        <span class="n">color_map_in</span> <span class="o">=</span> <span class="n">C_COLORS</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i_colors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_colors</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_map_in</span><span class="p">):</span>
            <span class="n">i_colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_colors</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i_colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">color_map_in</span><span class="p">)))</span>

    <span class="c1"># repeat color map as many times as necessary to get n_colors</span>
    <span class="n">color_map_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_colors</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_map_in</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)):</span>
        <span class="n">color_map_out</span> <span class="o">=</span> <span class="n">color_map_out</span> <span class="o">+</span> <span class="p">[</span><span class="n">color_map_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">i_colors</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">color_map_out</span></div>


<div class="viewcode-block" id="plot_colormap_values"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_colormap_values">[docs]</a><span class="k">def</span> <span class="nf">plot_colormap_values</span><span class="p">(</span><span class="n">cmap</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Plot RGB values of a colormap across the full range.</span>

<span class="sd">    :param cmap: colormap as returned by plt.cm.get_cmap()</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get 100 colormap values</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)])</span>

    <span class="c1"># extract and plot RGB values</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">))]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">))]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">))]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;-r&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;-g&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">)</span>

    <span class="c1"># plot color bar above</span>
    <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cm</span><span class="p">))]</span></div>


<div class="viewcode-block" id="format_fig"><a class="viewcode-back" href="../p_plot.html#p_plot.format_fig">[docs]</a><span class="k">def</span> <span class="nf">format_fig</span><span class="p">(</span><span class="n">handle_fig</span><span class="p">,</span> <span class="n">handle_ax</span><span class="p">,</span> <span class="n">fig_size_inches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">b_remove_box</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_remove_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_make_ticklabel_font_sansserif</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Format figures/axes after plotting.</span>

<span class="sd">    :param handle_fig: (list of) handle(s) of figures to be formatted</span>
<span class="sd">    :type handle_fig: matplotlib.figure.Figure</span>
<span class="sd">    :param handle_ax: (list of) handle(s) of axes to be formatted</span>
<span class="sd">    :type handle_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :param fig_size_inches: tuple (x, y) determining the size of the figure</span>
<span class="sd">    :type fig_size_inches: tuple or list</span>
<span class="sd">    :param x_label: new x-axis label</span>
<span class="sd">    :type x_label: str</span>
<span class="sd">    :param y_label: new y-axis label</span>
<span class="sd">    :type y_label: str</span>
<span class="sd">    :param b_remove_box: remove the top and right frame lines while keeping the axes intact</span>
<span class="sd">    :type b_remove_box: bool or int</span>
<span class="sd">    :param b_remove_legend: self explanatory</span>
<span class="sd">    :type b_remove_legend: bool or int</span>
<span class="sd">    :param b_make_ticklabel_font_sansserif: make ticklabels font sans-serif (maybe necessary with latex text formatting)</span>
<span class="sd">        for technical reasons, ticklabels get removed if there is no axis label. to keep ticklabels in this case, set</span>
<span class="sd">        the axis label to a whitespce beforehand, e.g.: ax.set_xlabel(&#39; &#39;)</span>
<span class="sd">    :type b_make_ticklabel_font_sansserif: bool or int</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if figure and axis handles are single elements, convert them to lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle_fig</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">handle_fig</span> <span class="o">=</span> <span class="p">[</span><span class="n">handle_fig</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle_ax</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">handle_ax</span> <span class="o">=</span> <span class="p">[</span><span class="n">handle_ax</span><span class="p">]</span>

    <span class="c1"># change figure properties</span>
    <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">handle_fig</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fig_size_inches</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">fig_size_inches</span><span class="p">)</span>

    <span class="c1"># change axis properties</span>
    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">handle_ax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b_remove_legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_legend</span><span class="p">()</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">x_label</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y_label</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_remove_box</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># make ticklabels have sans serif fonts (might be necessary if using latex text formatting). extracts tick vlaues,</span>
    <span class="c1"># convert to int if w/o decimals, convert to strings and replace ASCII minus sign with Unicode one (long dash).</span>
    <span class="c1"># ticklabels get removed if the is no axis label. to keep ticklabels in this case, set the axis label to a whitespce</span>
    <span class="c1"># beforehand, e.g.: ax.set_xlabel(&#39; &#39;)</span>
    <span class="c1"># ATTENTION: this should probably stay towards the end of this function as resizing axes/fonts can change labels)</span>
    <span class="k">if</span> <span class="n">b_make_ticklabel_font_sansserif</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">handle_ax</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">()):</span>
                <span class="n">xticks</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">xticks</span><span class="p">]):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2212</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">xticks</span><span class="p">],</span>
                                       <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2212</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">xticks</span><span class="p">],</span>
                                       <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">})</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">()):</span>
                <span class="n">yticks</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">tick</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">]):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2212</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span>
                                       <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">})</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2212</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">yticks</span><span class="p">],</span>
                                       <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="s1">&#39;sans-serif&#39;</span><span class="p">})</span></div>


<div class="viewcode-block" id="plot_traces_spikes_mod"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_traces_spikes_mod">[docs]</a><span class="k">def</span> <span class="nf">plot_traces_spikes_mod</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">spikemons</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">artificial_spike_height</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">b_spike_threshold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_share_y_axis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_circuit_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">b_circuit_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_circuit_probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_circuit_idx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">b_maxmin_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot voltage trace of membrane potential for one model neuron per population in one subplot each, as well as</span>
<span class="sd">    one subplot containing spike times from all neurons. An additional subplot contains a network diagram. One figure</span>
<span class="sd">    is created for each brian2 StateMonitor object in argument statemons.</span>

<span class="sd">    :param statemons: (list of) brian2 StateMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type statemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param spikemons: (list of) brian2 SpikeMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type spikemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param neuron_idx: [default=0] index of the neuron(s) for which the data should be plotted. Can be single integer</span>
<span class="sd">        or list of integers with length==number of populations. If a single value is passed and the data contain several</span>
<span class="sd">        populations (as per info), then the single value will be used for all populations (e.g. 0 means the first neuron</span>
<span class="sd">        of each population will be plotted).</span>
<span class="sd">    :type neuron_idx: int or list</span>
<span class="sd">    :param artificial_spike_height: [default=0] height in mV of vertical lines representing spikes. 0 means no lines.</span>
<span class="sd">    :type artificial_spike_height: int or float</span>
<span class="sd">    :param b_spike_threshold: [default=True] if true plots the spike threshold (value from info) as gray dotted line</span>
<span class="sd">    :type b_spike_threshold: bool</span>
<span class="sd">    :param b_share_y_axis: [default=True] if true, all voltage trace subplots share the same y-axis limits</span>
<span class="sd">    :type b_share_y_axis: bool</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param b_circuit_weight: [default=True] plot synaptic weight values next to connecting lines in circuit diagram</span>
<span class="sd">    :type b_circuit_weight: bool</span>
<span class="sd">    :param b_circuit_delay: [default=True] plot synaptic delay values next to connecting lines</span>
<span class="sd">    :type b_circuit_delay: bool</span>
<span class="sd">    :param b_circuit_probability: [default=True] plot synaptic connection probability values next to connecting lines</span>
<span class="sd">    :type b_circuit_probability: bool</span>
<span class="sd">    :param b_circuit_idx: [default=False] plot synapse index next to connecting lines</span>
<span class="sd">    :type b_circuit_idx: bool</span>
<span class="sd">    :param b_maxmin_marker: [default=False] mark maximum and minimum of each trace (if above/below initial voltage)</span>
<span class="sd">    :type b_maxmin_marker: bool</span>
<span class="sd">    :param b_derivative: plot derivative of each trace, rescaled and shifted to trace plot</span>
<span class="sd">    :type b_derivative: bool</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle(s)</span>
<span class="sd">        - axes: axis handles, one sublist per figure</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: [matplotlib.figure.Figure]</span>
<span class="sd">        - axes: [[matplotlib.axes._subplots.AxesSubplot]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if statemons and spikemons contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">statemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">spikemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">spikemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">neuron_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">statemonitor</span><span class="o">.</span><span class="n">StateMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">),</span> \
        <span class="s2">&quot;statemons must be a list of b2.StateMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">spikemonitor</span><span class="o">.</span><span class="n">SpikeMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">),</span> \
        <span class="s2">&quot;spikemons must be a list of b2.SpikeMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">neuron_idx</span><span class="p">),</span> \
        <span class="s2">&quot;neuron_idx must be an integer or list of integers&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;statemons, spikemons and info must all have the same number of elements&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">artificial_spike_height</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="nb">isinstance</span><span class="p">(</span><span class="n">artificial_spike_height</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="s2">&quot;artificial_spike_height must be int or float&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes_current</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">b_input_current_has_been_plotted</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">n_figs</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: More than 20 figures are about to be created...&quot;</span><span class="p">)</span>

    <span class="c1"># loop through list of state monitors</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_figs</span><span class="p">):</span>
        <span class="c1"># if single neuron index was supplied, repeat that for each population</span>
        <span class="n">n_populations</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;n_populations&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n_populations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nrn_idx_per_pop</span> <span class="o">=</span> <span class="n">neuron_idx</span> <span class="o">*</span> <span class="n">n_populations</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_populations</span><span class="p">:</span>
            <span class="n">nrn_idx_per_pop</span> <span class="o">=</span> <span class="n">neuron_idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument neuron_idx must be a single integer or a list of integers with&quot;</span>
                             <span class="s2">&quot; length==number of populations&quot;</span><span class="p">)</span>
        <span class="c1"># test if any neuron index is outside of the range of neurons for any of the populations</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">nrn_idx_per_pop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Neuron indices &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_per_pop</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; are outside of the range of neurons in the&quot;</span>
                             <span class="s2">&quot; populations of sizes &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">]))</span>
        <span class="c1"># get absolute neuron indices, i.e. the index to the totality of neurons, independent of the neuron&#39;s population</span>
        <span class="n">nrn_idx_abs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nrn_idx_per_pop</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][:</span><span class="n">p</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;. plotting neurons &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_abs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; (neurons &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_per_pop</span><span class="p">)</span> <span class="o">+</span>
              <span class="s2">&quot; of their respective populations of size &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>

        <span class="c1"># create figure and set up grid for subplots</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">n_populations</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># last row is for spike times</span>
        <span class="n">fig_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_tmp</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">axes_current</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">color_map_light</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS_LIGHT</span><span class="p">)</span>
        <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">)</span>

        <span class="c1"># loop through populations in current statemonitor and plot the voltage trace for the example neuron in each pop</span>
        <span class="n">max_voltage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">min_voltage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">):</span>
            <span class="c1"># absolute index of current neuron</span>
            <span class="n">nrn</span> <span class="o">=</span> <span class="n">nrn_idx_abs</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span>
            <span class="c1"># set up subplot</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;v [mV]&#39;</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="c1"># plot threshold potential</span>
            <span class="n">v_thresh_cur_nrn</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;v_thresh&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">b_spike_threshold</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span><span class="p">],</span>
                                    <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">pop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="s1">&#39;spike threshold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="c1"># plot input current (if non-zero)</span>
            <span class="n">axis_current_tmp</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_current_tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="s1">&#39;Ie&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Ie</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Ie</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">nA</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="n">color_map_light</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ie [nA]&#39;</span><span class="p">)</span>
                <span class="n">b_input_current_has_been_plotted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># plot voltage traces</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">pop</span><span class="p">])</span>
            <span class="c1"># plot artificial spikes</span>
            <span class="k">if</span> <span class="n">artificial_spike_height</span><span class="p">:</span>
                <span class="n">spiketimes_cur_nrn</span> <span class="o">=</span> <span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">nrn</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_cur_nrn</span><span class="p">)):</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">spiketimes_cur_nrn</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">spiketimes_cur_nrn</span><span class="p">[</span><span class="n">s</span><span class="p">]],</span>
                                        <span class="p">[</span><span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span> <span class="o">+</span> <span class="n">artificial_spike_height</span><span class="p">],</span>
                                        <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">pop</span><span class="p">])</span>
            <span class="c1"># get max/min for y-axis</span>
            <span class="n">max_voltage_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
            <span class="n">min_voltage_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_voltage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_voltage_cur</span> <span class="o">&gt;</span> <span class="n">max_voltage</span><span class="p">:</span>
                <span class="n">max_voltage</span> <span class="o">=</span> <span class="n">max_voltage_cur</span>
            <span class="k">if</span> <span class="n">min_voltage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">min_voltage_cur</span> <span class="o">&lt;</span> <span class="n">min_voltage</span><span class="p">:</span>
                <span class="n">min_voltage</span> <span class="o">=</span> <span class="n">min_voltage_cur</span>
            <span class="c1"># plot marker at maximum / minimum voltage</span>
            <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                <span class="n">initial_voltage</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                <span class="k">if</span> <span class="n">max_voltage_cur</span> <span class="o">&gt;</span> <span class="n">initial_voltage</span><span class="p">:</span>
                    <span class="n">i_max_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                    <span class="n">t_max_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_max_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="n">max_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="n">max_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;  ttp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms, amp: &#39;</span> <span class="o">+</span>
                                                                  <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">max_voltage_cur</span> <span class="o">-</span> <span class="n">initial_voltage</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                                                  <span class="s1">&#39;mV&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_max_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_25_percent</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;  25</span><span class="si">% r</span><span class="s1">t: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">min_voltage_cur</span> <span class="o">&lt;</span> <span class="n">initial_voltage</span><span class="p">:</span>
                    <span class="n">i_min_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                    <span class="n">t_min_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_min_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="n">min_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="n">min_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;  ttp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms, amp: &#39;</span> <span class="o">+</span>
                                                                  <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">min_voltage_cur</span> <span class="o">-</span> <span class="n">initial_voltage</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                                                  <span class="s1">&#39;mV&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_min_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_25_percent</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;  25</span><span class="si">% r</span><span class="s1">t: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="c1"># plot derivative of trace</span>
            <span class="k">if</span> <span class="n">b_derivative</span><span class="p">:</span>
                <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                <span class="n">min_g</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="n">max_g</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="n">scaling_factor_g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_g</span> <span class="o">-</span> <span class="n">min_g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_voltage_cur</span> <span class="o">-</span> <span class="n">min_voltage_cur</span><span class="p">)</span>
                <span class="n">gradient_rescaled</span> <span class="o">=</span> <span class="n">gradient</span> <span class="o">*</span> <span class="n">scaling_factor_g</span>
                <span class="n">gradient_shifted</span> <span class="o">=</span> <span class="n">gradient_rescaled</span> <span class="o">-</span> <span class="n">min_g</span> <span class="o">*</span> <span class="n">scaling_factor_g</span> <span class="o">+</span> <span class="n">min_voltage_cur</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">gradient_shifted</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_g</span><span class="p">):</span>
                        <span class="n">t_max_g</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gradient</span><span class="p">)]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span>
                                            <span class="s1">&#39;  gradient: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_g</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_g</span><span class="p">):</span>
                        <span class="n">t_min_g</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">gradient</span><span class="p">)]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span>
                                            <span class="s1">&#39;  gradient: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

        <span class="c1"># set up subplot in last grid row for spike times</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
        <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
        <span class="c1"># plot spike times</span>
        <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">):</span>
            <span class="c1"># absolute index of current neuron</span>
            <span class="n">nrn</span> <span class="o">=</span> <span class="n">nrn_idx_abs</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span>
            <span class="c1"># plot spike events in last subplot</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">eventplot</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">nrn</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span>
                                              <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">lineoffsets</span><span class="o">=</span><span class="n">pop</span><span class="p">)</span>
        <span class="c1"># add right hand axis for label &quot;spike times&quot;</span>
        <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Spike times&#39;</span><span class="p">)</span>
        <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># share y axis among voltage trace plots and x axis (time) among all horizontal plots</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">b_share_y_axis</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">2</span><span class="p">)]</span>
            <span class="p">[</span><span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span>
                                                           <span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">2</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b_input_current_has_been_plotted</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># disable x tick labels for voltage trace plots and autoscale all axes</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="p">[</span><span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># set axis labels</span>
        <span class="k">if</span> <span class="n">b_share_y_axis</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_voltage</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="n">max_voltage</span> <span class="o">+</span> <span class="n">artificial_spike_height</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="p">[</span><span class="n">axes_current</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># set y tick labels of spike plot to population ids, and other settings</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">nrn_ids_text</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_per_pop</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">)]</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">nrn_ids_text</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Neuron #&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>

        <span class="c1"># plot network diagram in right grid column</span>
        <span class="n">axis_net</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_net</span><span class="p">)</span>
        <span class="n">plot_circuit_diagram</span><span class="p">(</span><span class="n">axis_net</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">b_weight</span><span class="o">=</span><span class="n">b_circuit_weight</span><span class="p">,</span> <span class="n">b_delay</span><span class="o">=</span><span class="n">b_circuit_delay</span><span class="p">,</span>
                             <span class="n">b_probability</span><span class="o">=</span><span class="n">b_circuit_probability</span><span class="p">,</span> <span class="n">b_syn_idx</span><span class="o">=</span><span class="n">b_circuit_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_traces_mod"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_traces_mod">[docs]</a><span class="k">def</span> <span class="nf">plot_traces_mod</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">b_spike_threshold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_average_aggregate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">t_offset_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">trace_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">average_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot voltage traces of ALL model neurons of one run into one figure, one subplot per neuron.</span>

<span class="sd">    :param statemons: (list of) brian2 StateMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type statemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param b_spike_threshold: [default=True] if true plots the spike threshold (value from info) as gray dotted line</span>
<span class="sd">    :type b_spike_threshold: bool</span>
<span class="sd">    :param b_average_aggregate: if true, treat statemons as aggregate of parex and plot all traces in single figure</span>
<span class="sd">    :type b_average_aggregate: bool</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param marker_linestyle: linestyle for event marker (default: &#39;--&#39; = dashed line)</span>
<span class="sd">    :type marker_linestyle: str</span>
<span class="sd">    :param t_offset_ms: [default=0] time value in milliseconds to offset the plot by (e.g. to align to an event)</span>
<span class="sd">    :type t_offset_ms: int or float</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param trace_color: single color value to use for all traces</span>
<span class="sd">    :type trace_color: list or None</span>
<span class="sd">    :param average_color: single color value to use for trace average</span>
<span class="sd">    :type average_color: list or None</span>
<span class="sd">    :param h_ax: handle to the axis in which the traces are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle(s)</span>
<span class="sd">        - axes: axis handles, one sublist per figure</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: [matplotlib.figure.Figure]</span>
<span class="sd">        - axes: [[matplotlib.axes._subplots.AxesSubplot]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if statemons and info contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">statemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;statemons and info must have the same number of elements&quot;</span>
    <span class="k">if</span> <span class="n">h_ax</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b_average_aggregate</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Plotting to a specified axis (arg h_ax) might only work with b_average_aggregate&quot;</span><span class="p">)</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>

    <span class="c1"># prepare figure and axis</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_figs</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b_average_aggregate</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: More than 20 figures are about to be created...&quot;</span><span class="p">)</span>

    <span class="c1"># get absolute minimum, maximum and range of all traces for y-axis limits</span>
    <span class="n">abs_min_trc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">v</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">))])</span>
    <span class="n">abs_max_trc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">v</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">))])</span>

    <span class="c1"># loop through list of state monitors</span>
    <span class="n">idx_ax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># counter for axis list (only gets incremented when plotting multiple figures</span>
    <span class="n">idx_ax_nrn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># counter for axis list (only gets incremented when plotting multiple figures</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)):</span>
        <span class="c1"># create figure and set up grid for subplots (if b_average_aggregate, only create one figure</span>
        <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">b_average_aggregate</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b_average_aggregate</span> <span class="ow">and</span> <span class="n">mon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
                <span class="n">fig_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
                <span class="n">fig_tmp</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">fig_tmp</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; - populations: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">]))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_tmp</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">idx_ax</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># set up subplots</span>
        <span class="k">if</span> <span class="n">n_neurons</span> <span class="o">&gt;</span> <span class="mi">144</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">/</span><span class="mi">12</span><span class="p">))</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_neurons</span> <span class="o">/</span> <span class="n">n_gridcols</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
        <span class="n">n_populations</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;n_populations&#39;</span><span class="p">]</span>
        <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">b_average_aggregate</span><span class="p">:</span>
            <span class="n">idx_ax_nrn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>
            <span class="c1"># get population index of current neuron</span>
            <span class="n">idx_nrn_relative</span><span class="p">,</span> <span class="n">idx_pop_cur_nrn</span> <span class="o">=</span> <span class="n">p_util</span><span class="o">.</span><span class="n">get_rel_from_abs_nrn_idx</span><span class="p">(</span><span class="n">nrn</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span>
            <span class="c1"># set up subplot</span>
            <span class="p">[</span><span class="n">sp_col</span><span class="p">,</span> <span class="n">sp_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">nrn</span><span class="p">,</span> <span class="n">n_gridrows</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_average_aggregate</span> <span class="ow">or</span> <span class="p">(</span><span class="n">b_average_aggregate</span> <span class="ow">and</span> <span class="n">nrn</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">sp_row</span><span class="p">,</span> <span class="n">sp_col</span><span class="p">),</span>
                                                         <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span>
                <span class="n">idx_ax_nrn</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that time</span>
                <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                     <span class="n">linestyle</span><span class="o">=</span><span class="n">marker_linestyle</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># for &quot;playback&quot; text, see plot_traces_spikes_mod()</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="c1"># plot threshold potential</span>
                <span class="k">if</span> <span class="n">b_spike_threshold</span><span class="p">:</span>
                    <span class="n">v_thresh_cur_nrn</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;v_thresh&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span><span class="p">],</span>
                                                  <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">nrn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="s1">&#39;spike threshold&#39;</span><span class="p">,</span>
                                 <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
            <span class="c1"># plot voltage traces</span>
            <span class="k">if</span> <span class="n">trace_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">color_cur</span> <span class="o">=</span> <span class="n">color_map_dark</span><span class="p">[</span><span class="n">idx_pop_cur_nrn</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color_cur</span> <span class="o">=</span> <span class="n">trace_color</span>
            <span class="k">if</span> <span class="n">b_average_aggregate</span> <span class="ow">and</span> <span class="n">mon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;model&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">,</span>
                                          <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># plot neuron index</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_average_aggregate</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">],</span> <span class="n">abs_min_trc</span><span class="p">,</span>
                                              <span class="nb">str</span><span class="p">(</span><span class="n">nrn</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx_nrn_relative</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                                              <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="c1"># to plot input current, see plot_traces_spikes_mod()</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">abs_min_trc</span><span class="p">,</span> <span class="n">abs_max_trc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrn</span> <span class="o">&lt;</span> <span class="n">n_neurons</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nrn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>

        <span class="c1"># share x axis (time) among all  plots</span>
        <span class="k">if</span> <span class="n">n_neurons</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># other settings</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;v [mV]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">])</span>

    <span class="c1"># plot mean if aggregate</span>
    <span class="k">if</span> <span class="n">b_average_aggregate</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">average_color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">average_color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">v</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">average_color</span><span class="p">,</span>
                                      <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
            <span class="n">fig_tmp</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; run &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;run_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s1">&#39; - all traces from aggregate plus average (black)&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">idx_ax</span><span class="p">][</span><span class="n">idx_ax_nrn</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="plot_traces_rec"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_traces_rec">[docs]</a><span class="k">def</span> <span class="nf">plot_traces_rec</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">spiketimes_ms_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">b_detect_spikes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">b_detect_onsets</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_plot_raw_traces</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_plot_smoothed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">b_plot_derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_plot_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_n_in_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_offset_by_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">b_average_mean_2std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_std_interval</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">t_baseline_ms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">trace_color_smooth</span><span class="o">=</span><span class="s1">&#39;xkcd:orangered&#39;</span><span class="p">,</span>
                    <span class="n">average_color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">t_offset_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot one or more recorded voltage traces in a single figure.</span>

<span class="sd">    :param traces: (list of) numpy ndarray(s) of voltage traces</span>
<span class="sd">    :type traces: np.ndarray or list</span>
<span class="sd">    :param spiketimes_ms_in: [default=None] optional list of spiketimes (see return). If None and b_detect_spikes=True,</span>
<span class="sd">        spiketimes will be calculated</span>
<span class="sd">    :type spiketimes_ms_in: [[float]] or None</span>
<span class="sd">    :param sampling_frequency_khz: [default=40] sampling frequency of traces in kHz</span>
<span class="sd">    :type sampling_frequency_khz: int or float</span>
<span class="sd">    :param b_detect_spikes: [default=False] detect spikes and mark spike peaks in plot</span>
<span class="sd">    :type b_detect_spikes: bool</span>
<span class="sd">    :param b_detect_onsets: [default=False] detect and mark spike onsets</span>
<span class="sd">    :type b_detect_onsets: bool</span>
<span class="sd">    :param b_subplots: [default=False] if multiple traces were passed, plot them in separate subplots, not overlaid</span>
<span class="sd">    :type b_subplots: bool</span>
<span class="sd">    :param b_plot_raw_traces: [default=True] plot individual raw traces (turn of if e.g. only plotting average)</span>
<span class="sd">    :type b_plot_raw_traces: bool</span>
<span class="sd">    :param b_plot_smoothed: [default=False] plot the smoothed traces (required to plot derivative)</span>
<span class="sd">    :type b_plot_smoothed: bool</span>
<span class="sd">    :param b_plot_derivative: [default=False] plot the derivative of each trace (depends on b_plot_smoothed)</span>
<span class="sd">    :type b_plot_derivative: bool</span>
<span class="sd">    :param b_plot_average: [default=False] plot average of traces (if b_subplots is false)</span>
<span class="sd">    :type b_plot_average: bool</span>
<span class="sd">    :param b_n_in_legend: [default=True] if False, don&#39;t plot number of traces in legend</span>
<span class="sd">    :type b_n_in_legend: bool</span>
<span class="sd">    :param b_offset_by_average: [default=False] offset each individual trace by its average (e.g. to correct for drift)</span>
<span class="sd">    :type b_offset_by_average: bool</span>
<span class="sd">    :param b_average_mean_2std: [default=False] plot horizontal lines for mean and 2 * standard deviation of average</span>
<span class="sd">        within t_baseline</span>
<span class="sd">    :type b_average_mean_2std: bool</span>
<span class="sd">    :param b_std_interval: [default=False] plot interval +/- 1 standard deviation around average</span>
<span class="sd">    :type b_std_interval: bool</span>
<span class="sd">    :param t_baseline_ms: [default=None] two-element list of start and end in milliseconds of baseline for mean &amp; std</span>
<span class="sd">    :type t_baseline_ms: list or None</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param marker_linestyle: linestyle for event marker (default: &#39;--&#39; = dashed line)</span>
<span class="sd">    :type marker_linestyle: str</span>
<span class="sd">    :param trace_color_smooth: single color value to use for all smoothed traces</span>
<span class="sd">    :type trace_color_smooth: list or str or None</span>
<span class="sd">    :param average_color: single color value to use for trace average</span>
<span class="sd">    :type average_color: list or str or None</span>
<span class="sd">    :param t_offset_ms: [default=0] time value in milliseconds to offset the plot by (e.g. to align to an event)</span>
<span class="sd">    :type t_offset_ms: int or float</span>
<span class="sd">    :param h_ax: handle to the axis in which the traces are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values. Only works if b_subplots==False.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axes: list of axis handles</span>
<span class="sd">        - spiketimes_ms_calculated: list of list(s) of spike times (in milliseconds). One sublist per trace.</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axes: [matplotlib.axes._subplots.AxesSubplot]</span>
<span class="sd">        - spiketimes_ms_calculated: [[float]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if traces contains a single trace, convert it to a list</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="p">[</span><span class="n">traces</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sampling_frequency_khz</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">sampling_frequency_khz</span> <span class="o">=</span> <span class="p">[</span><span class="n">sampling_frequency_khz</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sampling_frequency_khz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sampling_frequency_khz</span> <span class="o">=</span> <span class="n">sampling_frequency_khz</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">),</span> \
        <span class="s2">&quot;traces must be a numpy ndarray or list of ndarrays&quot;</span>
    <span class="k">if</span> <span class="n">b_plot_derivative</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">b_plot_smoothed</span><span class="p">:</span>
        <span class="n">b_plot_derivative</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: gradient not plotted, because b_plot_smoothed == False&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_detect_onsets</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">spiketimes_ms_in</span> <span class="ow">or</span> <span class="n">b_detect_spikes</span><span class="p">,</span> <span class="s2">&quot;spike onset detection only possible if &quot;</span> <span class="o">+</span> \
            <span class="s2">&quot;spiketimes_ms_in is not None or b_detect_spikes is True&quot;</span>
    <span class="k">if</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">b_subplots</span><span class="p">,</span> <span class="s2">&quot;plotting in passed axis only possible if b_subplots == False&quot;</span>

    <span class="c1"># create figure</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>

    <span class="c1"># misc variables</span>
    <span class="n">n_traces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
    <span class="n">max_dur</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">smoothing_filter_window_length</span> <span class="o">=</span> <span class="mi">11</span>

    <span class="c1"># offset traces by their average (e.g. to correct for long term drift during recording)</span>
    <span class="k">if</span> <span class="n">b_offset_by_average</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_traces</span><span class="p">):</span>
            <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span>

    <span class="c1"># smooth traces using savitzky-golay filter (from scipy.signal)</span>
    <span class="k">if</span> <span class="n">b_plot_smoothed</span><span class="p">:</span>
        <span class="n">traces_smooth_sg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_traces</span><span class="p">):</span>
            <span class="n">traces_smooth_sg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="n">smoothing_filter_window_length</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="c1"># get absolute minimum, maximum and range of all traces for y-axis limits</span>
    <span class="n">abs_min_trc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">))])</span>
    <span class="n">abs_max_trc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traces</span><span class="p">))])</span>
    <span class="n">abs_rng_trc</span> <span class="o">=</span> <span class="n">abs_max_trc</span> <span class="o">-</span> <span class="n">abs_min_trc</span>

    <span class="c1"># calculate the derivative / gradient of each trace and set negatives value to zero</span>
    <span class="k">if</span> <span class="n">b_plot_derivative</span><span class="p">:</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_traces</span><span class="p">):</span>
            <span class="n">gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">traces_smooth_sg</span><span class="p">[</span><span class="n">trc</span><span class="p">]))</span>
            <span class="n">gradients</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">gradients</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># get absolute minimum, maximum and range of the derivative / gradient of each trace</span>
        <span class="n">abs_min_grd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">gradients</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gradients</span><span class="p">))])</span>
        <span class="n">abs_max_grd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gradients</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gradients</span><span class="p">))])</span>
        <span class="n">abs_rng_grd</span> <span class="o">=</span> <span class="n">abs_max_grd</span> <span class="o">-</span> <span class="n">abs_min_grd</span>
        <span class="c1"># normalize derivatives / gradients to the absolute range of the traces</span>
        <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_traces</span><span class="p">):</span>
            <span class="n">gradients</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gradients</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span> <span class="o">-</span> <span class="n">abs_min_grd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">abs_rng_trc</span> <span class="o">/</span> <span class="n">abs_rng_grd</span><span class="p">)</span> <span class="o">+</span> <span class="n">abs_min_trc</span>

    <span class="c1"># set up subplots</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">b_subplots</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">80</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_traces</span> <span class="o">/</span> <span class="n">n_gridcols</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span>
        <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
        <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">marker_linestyle</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>

    <span class="c1"># detect spiketimes (optional)</span>
    <span class="k">if</span> <span class="n">b_detect_spikes</span><span class="p">:</span>
        <span class="p">[</span><span class="n">spiketimes_grd</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">thresholds_used_grd</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_spiketimes</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">smooth_filter_win_len</span><span class="o">=</span><span class="n">smoothing_filter_window_length</span><span class="p">)</span>
        <span class="n">spiketimes_ms_calculated</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spiketimes_grd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spiketimes_ms_calculated</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># loop through traces and plot</span>
    <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_traces</span><span class="p">):</span>
        <span class="n">n_values</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="n">dur_sample</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span>
        <span class="n">dur_trace</span> <span class="o">=</span> <span class="n">dur_sample</span> <span class="o">*</span> <span class="n">n_values</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dur_trace</span><span class="p">,</span> <span class="n">n_values</span><span class="p">)</span>
        <span class="c1"># set up axis (if one subplot per trace)</span>
        <span class="k">if</span> <span class="n">b_subplots</span><span class="p">:</span>
            <span class="p">[</span><span class="n">sp_col</span><span class="p">,</span> <span class="n">sp_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">trc</span><span class="p">,</span> <span class="n">n_gridrows</span><span class="p">)</span>
            <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">sp_row</span><span class="p">,</span> <span class="n">sp_col</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">marker_linestyle</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="c1"># plot spike detection threshold (and normalize to the absolute range used to plot traces)</span>
            <span class="k">if</span> <span class="n">b_detect_spikes</span> <span class="ow">and</span> <span class="n">b_plot_derivative</span><span class="p">:</span>
                <span class="n">thresh_for_plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">thresholds_used_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span> <span class="o">-</span> <span class="n">abs_min_grd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">abs_rng_trc</span> <span class="o">/</span> <span class="n">abs_rng_grd</span><span class="p">)</span> <span class="o">+</span> <span class="n">abs_min_trc</span>
                <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">dur_trace</span><span class="p">],</span> <span class="p">[</span><span class="n">thresh_for_plot</span><span class="p">,</span> <span class="n">thresh_for_plot</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:lightblue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gradient theshold&#39;</span><span class="p">)</span>

        <span class="c1"># plot derivatives / gradients</span>
        <span class="k">if</span> <span class="n">b_plot_derivative</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span> <span class="ow">and</span> <span class="n">trc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">gradients</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:azure&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">gradients</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:azure&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">)</span>

        <span class="c1"># plot raw traces</span>
        <span class="k">if</span> <span class="n">b_plot_raw_traces</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span> <span class="ow">and</span> <span class="n">trc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;recorded trace [mV]&#39;</span><span class="p">)</span>

        <span class="c1"># plot smoothed trace</span>
        <span class="k">if</span> <span class="n">b_plot_smoothed</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span> <span class="ow">and</span> <span class="n">trc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">traces_smooth_sg</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">trace_color_smooth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">traces_smooth_sg</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">trace_color_smooth</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="s1">&#39;smoothed recorded trace [mV]&#39;</span><span class="p">)</span>

        <span class="c1"># mark calculated spike peaks</span>
        <span class="k">if</span> <span class="n">b_detect_spikes</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_grd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">trc</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># plt.plot([t / sampling_frequency_hz for t in spiketimes[trc]], traces[trc][spiketimes[trc]], &#39;+k&#39;,</span>
                <span class="c1">#          markersize=14)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span> <span class="ow">and</span> <span class="n">trc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_values</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spiketimes_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">]])</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span>
                             <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">spiketimes_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">]],</span>
                             <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:orangered&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_values</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">spiketimes_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">]])</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span>
                             <span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">spiketimes_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">]],</span>
                             <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;xkcd:orangered&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;detected spikes&#39;</span><span class="p">)</span>
                <span class="c1"># convert spiketimes from samples to milliseconds</span>
                <span class="n">spiketimes_ms_calculated</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spiketimes_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span>
                                                 <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_grd</span><span class="p">[</span><span class="n">trc</span><span class="p">]))])</span>
        <span class="c1"># if (loaded?) spiketimes were passed, also plot those</span>
        <span class="k">if</span> <span class="n">spiketimes_ms_in</span><span class="p">:</span>
            <span class="n">spiketimes_samp_in</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span>
                                  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">]))]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span> <span class="ow">and</span> <span class="n">trc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="p">[</span><span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spiketimes_samp_in</span><span class="p">],</span> <span class="s1">&#39;+g&#39;</span><span class="p">,</span>
                         <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="p">[</span><span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">s</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spiketimes_samp_in</span><span class="p">],</span> <span class="s1">&#39;+g&#39;</span><span class="p">,</span>
                         <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;loaded spikes&#39;</span><span class="p">)</span>

        <span class="c1"># detect spike onsets</span>
        <span class="k">if</span> <span class="n">b_detect_onsets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spiketimes_ms_in</span><span class="p">:</span>
                <span class="n">spike_onsets_ms</span><span class="p">,</span> <span class="n">spike_thresholds</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_onset_of_spikes</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">]],</span> <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">b_detect_spikes</span><span class="p">:</span>
                <span class="n">spike_onsets_ms</span><span class="p">,</span> <span class="n">spike_thresholds</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_onset_of_spikes</span><span class="p">(</span><span class="n">traces</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">spiketimes_ms_calculated</span><span class="p">[</span><span class="n">trc</span><span class="p">]],</span> <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_onsets_ms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spike_thresholds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;xb&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;spike onsets&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spike onsets trace &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">trc</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spike_onsets_ms</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spike thresholds trace &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">trc</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">spike_thresholds</span><span class="p">))</span>

        <span class="c1"># keep track of maximum duration for axis limits</span>
        <span class="k">if</span> <span class="n">dur_trace</span> <span class="o">&gt;</span> <span class="n">max_dur</span><span class="p">:</span>
            <span class="n">max_dur</span> <span class="o">=</span> <span class="n">dur_trace</span>

        <span class="c1"># set axis limits etc. for each subplot</span>
        <span class="k">if</span> <span class="n">b_subplots</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dur</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">abs_min_trc</span><span class="p">,</span> <span class="n">abs_max_trc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trc</span> <span class="o">&lt;</span> <span class="n">n_traces</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>

    <span class="c1"># plot average of all traces (or smoothed traces if only those are plotted)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span> <span class="ow">and</span> <span class="n">b_plot_average</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">b_plot_smoothed</span><span class="p">:</span>
            <span class="n">average_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">traces_smooth_sg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">average_label</span> <span class="o">=</span> <span class="s1">&#39;smoothed recorded trace average [mV]&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">average_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">average_label</span> <span class="o">=</span> <span class="s1">&#39;recorded trace average [mV]&#39;</span>
        <span class="k">if</span> <span class="n">b_average_mean_2std</span> <span class="ow">and</span> <span class="n">t_baseline_ms</span><span class="p">:</span>
            <span class="n">average_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">average_trace</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">t_baseline_ms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                                 <span class="nb">round</span><span class="p">(</span><span class="n">t_baseline_ms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="n">average_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">average_trace</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">t_baseline_ms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                               <span class="nb">round</span><span class="p">(</span><span class="n">t_baseline_ms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sampling_frequency_khz</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">average_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">average_mean</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">average_std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">average_mean</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">average_std</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_std_interval</span><span class="p">:</span>
            <span class="n">std_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">traces_smooth_sg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">avg_plus_std_trc</span> <span class="o">=</span> <span class="n">average_trace</span> <span class="o">+</span> <span class="n">std_trace</span>
            <span class="n">avg_minus_std_trc</span> <span class="o">=</span> <span class="n">average_trace</span> <span class="o">-</span> <span class="n">std_trace</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">avg_plus_std_trc</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">average_color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">2.9</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;+/- 1 std&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">avg_minus_std_trc</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">average_color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">2.9</span><span class="p">)</span>
        <span class="c1"># plot trace average</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span> <span class="n">average_trace</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">average_color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">average_label</span><span class="p">)</span>

    <span class="c1"># set axis limits etc. for single plot, add extra label for legend displaying the number of traces</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dur</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [ms]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Potential [mV]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_n_in_legend</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;n = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_traces</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">spiketimes_ms_calculated</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="plot_isi_histogram"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_isi_histogram">[docs]</a><span class="k">def</span> <span class="nf">plot_isi_histogram</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">,</span> <span class="n">b_subplots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">axis_handle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                       <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the inter-spike interval (ISI) histograms of one or more neurons/traces in a single figure.</span>

<span class="sd">    :param spiketimes_ms_in: list of list(s) of spiketimes (in milliseconds). One sublist per trace. If None,</span>
<span class="sd">        spiketimes will be calculated</span>
<span class="sd">    :type spiketimes_ms_in: [[float]] or None</span>
<span class="sd">    :param b_subplots: [default=False] if multiple traces were passed, plot the histograms in separate subplots,</span>
<span class="sd">        rather than one overall histogram of all ISIs</span>
<span class="sd">    :type b_subplots: bool</span>
<span class="sd">    :param title: figure title to be plotted above histogram</span>
<span class="sd">    :type title: str</span>
<span class="sd">    :param alpha: alpha-level of the histogram bars. set to e.g. 0.5 if plotting multiple histograms in same axis</span>
<span class="sd">    :type alpha: float</span>
<span class="sd">    :param axis_handle: [default=None] handle of axis to plot in. if None, create a new figure.</span>
<span class="sd">    :type axis_handle: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :param label: [default=&#39;&#39;] label for histogram (useful if plotting multiple histograms into same axis).</span>
<span class="sd">        note: legend has to be added to axis after function call!</span>
<span class="sd">    :type label: str</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker for a event</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle (if one was created in this function)</span>
<span class="sd">        - axes: list of axis handles</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure or None</span>
<span class="sd">        - axes: [matplotlib.axes._subplots.AxesSubplot]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;spiketimes_ms_in must be a list of list(s) of spiketimes&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spiketimes_ms_in</span><span class="p">),</span> \
        <span class="s2">&quot;spiketimes_ms_in must be a list of list(s) of spiketimes&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s2">&quot;alpha must be a float between 0.0 and 1.0&quot;</span>
    <span class="k">if</span> <span class="n">axis_handle</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">b_subplots</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;if axis handle is supplied, b_subplots must be false&quot;</span>

    <span class="c1"># misc variables</span>
    <span class="n">n_traces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">)</span>
    <span class="n">n_spikes_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n_spikes_all</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
    <span class="n">max_dur</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># create figure</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">axis_handle</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># set up subplots</span>
    <span class="k">if</span> <span class="n">b_subplots</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">37</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="n">n_traces</span> <span class="o">&lt;</span> <span class="mi">49</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_traces</span> <span class="o">/</span> <span class="n">n_gridcols</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if no axis handle was passed, create a new one</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">axis_handle</span><span class="p">:</span>
            <span class="n">axis_handle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
        <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
        <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis_handle</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># loop through traces (i.e. sublists of spiketimes_ms_in), calculate ISIs and plot histogram</span>
    <span class="n">isis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_traces</span><span class="p">):</span>
        <span class="c1"># calculate ISIs</span>
        <span class="n">n_spikes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span>
        <span class="n">isis</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spiketimes_ms_in</span><span class="p">[</span><span class="n">trc</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_spikes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="c1"># set up axis (if one subplot per trace)</span>
        <span class="k">if</span> <span class="n">b_subplots</span><span class="p">:</span>
            <span class="p">[</span><span class="n">sp_col</span><span class="p">,</span> <span class="n">sp_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divmod</span><span class="p">(</span><span class="n">trc</span><span class="p">,</span> <span class="n">n_gridrows</span><span class="p">)</span>
            <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">sp_row</span><span class="p">,</span> <span class="n">sp_col</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># plot histogram of ISI</span>
            <span class="k">if</span> <span class="n">isis</span><span class="p">[</span><span class="n">trc</span><span class="p">]:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">isis</span><span class="p">[</span><span class="n">trc</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">isis</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                               <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">isis</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_dur</span><span class="p">:</span>
                    <span class="n">max_dur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">isis</span><span class="p">[</span><span class="n">trc</span><span class="p">])</span>
            <span class="c1"># set ticks and labels</span>
            <span class="k">if</span> <span class="n">trc</span> <span class="o">==</span> <span class="n">n_traces</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ISI [ms]&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
            <span class="k">if</span> <span class="n">trc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rel. frequency&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
            <span class="c1"># twin axis and add number of spikes as right-hand axis label</span>
            <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">trc</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_spikes</span><span class="p">))</span>
            <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># set axis limits etc. for single plot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">b_subplots</span><span class="p">:</span>
        <span class="c1"># plot histogram of ISI</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">isis</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isis</span><span class="p">))]):</span>
            <span class="n">axis_handle</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">isis</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">isis</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                             <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">axis_handle</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;ISI [ms]&#39;</span><span class="p">)</span>
        <span class="n">axis_handle</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Rel. frequency&#39;</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis_handle</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># set x-axis limits for all</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_dur</span><span class="p">)</span>

    <span class="c1"># output shortest isi</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">isis</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isis</span><span class="p">))]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot; shortest ISI: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">isis</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_traces_per_run"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_traces_per_run">[docs]</a><span class="k">def</span> <span class="nf">plot_traces_per_run</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">neuron_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">population_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_spike_threshold</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">virtual_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_offset_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_maxmin_marker</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">find_max_min_from_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">b_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_clipon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth_traces</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="n">CMAP_NAME_CONTINUOUS</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot voltage trace of membrane potential for multiple runs with a varying (free) parameter in one figure.</span>

<span class="sd">    :param statemons: (list of) brian2 StateMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type statemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param config: dictionary as loaded from .json configuration file</span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param neuron_idx: [default=0] index of the neuron(s) for which the data should be plotted. Can be single integer</span>
<span class="sd">        or list of integers with length==number of populations. If a single value is passed and the data contain several</span>
<span class="sd">        populations (as per info), then the single value will be used for all populations (e.g. 0 means the first neuron</span>
<span class="sd">        of each population will be plotted).</span>
<span class="sd">    :type neuron_idx: int or list</span>
<span class="sd">    :param population_idx: [default=None] index or list of indices of the population(s) for which traces are plotted.</span>
<span class="sd">        If None, plot the nth nrn of all pops.</span>
<span class="sd">    :type population_idx: int or list or None</span>
<span class="sd">    :param b_spike_threshold: [default=True] if true plots the spike threshold (value from info) as gray dotted line</span>
<span class="sd">    :type b_spike_threshold: bool</span>
<span class="sd">    :param virtual_threshold: [default=None] if not None, plot spike threshold here [mV] instead of the actual value</span>
<span class="sd">    :type virtual_threshold: float or int or None</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param t_offset_ms: [default=0] time value in milliseconds to offset the plot by (e.g. to align to an event)</span>
<span class="sd">    :type t_offset_ms: int or float</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param b_maxmin_marker: [default=False] mark maximum and minimum of each trace (if above/below initial voltage)</span>
<span class="sd">    :type b_maxmin_marker: bool</span>
<span class="sd">    :param find_max_min_from_ms: [default=0] look for maximum/minimum in trace after this time in milliseconds.</span>
<span class="sd">        only used if b_maxmin_marker is True. Should equal onset of presynaptic spike, as it&#39;s used in rise time calc</span>
<span class="sd">    :type find_max_min_from_ms: int</span>
<span class="sd">    :param b_legend: [default=True] add legend to plot</span>
<span class="sd">    :type b_legend: bool</span>
<span class="sd">    :param b_clipon: [default=True] if False, allows to plot beyond axis limits</span>
<span class="sd">    :type b_clipon: bool</span>
<span class="sd">    :param linewidth_traces: [default=1.5] linewidth for voltage traces</span>
<span class="sd">    :type linewidth_traces: float or int</span>
<span class="sd">    :param colormap: [default=&#39;viridis&#39; (defined by CMAP_NAME_CONTINUOUS)] name of matplotlib color map to use for trcs</span>
<span class="sd">    :type colormap: str</span>
<span class="sd">    :param h_ax: handle to the axis in which the psths are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>

<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axes: list of axis handles</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axes: [matplotlib.axes._subplots.AxesSubplot]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if statemons, info and neuron_idx contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">statemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">neuron_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">neuron_idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">population_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">population_idx</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">population_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">population_idx</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">statemonitor</span><span class="o">.</span><span class="n">StateMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">),</span> \
        <span class="s2">&quot;statemons must be a list of b2.StateMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">neuron_idx</span><span class="p">),</span> \
        <span class="s2">&quot;neuron_idx must be an integer or list of integers&quot;</span>
    <span class="k">if</span> <span class="n">population_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">population_idx</span><span class="p">),</span> \
            <span class="s2">&quot;population_idx must be an integer or list of integers (or None to plot a neuron from all populations)&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;statemons and info must have the same number of elements&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>

    <span class="c1"># get populations to plot</span>
    <span class="n">n_populations_total</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;n_populations&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">population_idx</span><span class="p">:</span>
        <span class="n">n_populations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">population_idx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_populations</span> <span class="o">=</span> <span class="n">n_populations_total</span>
        <span class="n">population_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">))</span>

    <span class="c1"># if single neuron index was supplied, repeat that for each population</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">n_populations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nrn_idx_per_pop</span> <span class="o">=</span> <span class="n">neuron_idx</span> <span class="o">*</span> <span class="n">n_populations</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neuron_idx</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_populations</span><span class="p">:</span>
        <span class="n">nrn_idx_per_pop</span> <span class="o">=</span> <span class="n">neuron_idx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument neuron_idx must be a single integer or a list of integers with&quot;</span>
                         <span class="s2">&quot; length==number of populations&quot;</span><span class="p">)</span>

    <span class="c1"># test if any neuron index is outside of the range of neurons for any of the populations</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">nrn_idx_per_pop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">population_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">)]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Neuron indices &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_per_pop</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; are outside of the range of neurons in the&quot;</span> <span class="o">+</span>
                         <span class="s2">&quot; population(s) &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">population_idx</span><span class="p">))</span>
    <span class="c1"># get absolute neuron indices, i.e. the index to the totality of neurons, independent of the neuron&#39;s population</span>
    <span class="n">nrn_idx_abs</span> <span class="o">=</span> <span class="p">[</span><span class="n">nrn_idx_per_pop</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][:</span><span class="n">population_idx</span><span class="p">[</span><span class="n">p</span><span class="p">]])</span>
                   <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;. plotting (plot_traces_per_run) neurons &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_abs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; (neurons &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn_idx_per_pop</span><span class="p">)</span> <span class="o">+</span>
          <span class="s2">&quot; of their respective populations&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">population_idx</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="c1"># if the free_parameter is a neuron parameter, subplot legend labels correspond to the free param value of the</span>
    <span class="c1"># respective population. if it&#39;s a synapse param, the label only takes the first free param value for all subplots</span>
    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;free_parameter_dict&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;parameters_nrn&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- free parameter is a synatptic parameter =&gt; ALL LEGEND ENTRIES REFER TO FIRST VALUE OF FREE PARAM&quot;</span><span class="p">)</span>

    <span class="c1"># create figure and axis. if an axis handle was passed, plot only the first population to that axis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">n_populations</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">population_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">population_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">colormap</span><span class="p">)</span>

    <span class="c1"># loop through values of the free parameter (either populations or synapses) and create a subplot for each</span>
    <span class="k">for</span> <span class="n">i_ax</span><span class="p">,</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">population_idx</span><span class="p">):</span>
        <span class="c1"># absolute index of current neuron</span>
        <span class="n">nrn</span> <span class="o">=</span> <span class="n">nrn_idx_abs</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span>
        <span class="n">mon</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">i_ax</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h_ax</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;v [mV]&#39;</span><span class="p">)</span>
        <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
        <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">,</span> <span class="s2">&quot;playback&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                            <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1"># plot threshold potential</span>
        <span class="k">if</span> <span class="n">b_spike_threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">virtual_threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v_thresh_cur_nrn</span> <span class="o">=</span> <span class="n">virtual_threshold</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v_thresh_cur_nrn</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;v_thresh&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">v_thresh_cur_nrn</span><span class="p">,</span> <span class="s1">&#39;spike threshold&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                     <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

        <span class="c1"># loop through list of state monitors</span>
        <span class="n">h_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_runs</span><span class="p">)):</span>
            <span class="c1"># plot voltage traces</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;free_parameter_dict&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;parameters_nrn&#39;</span><span class="p">:</span>
                <span class="n">free_param_val_label</span> <span class="o">=</span> <span class="s1">&#39;fpv[pop] </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;free_parameter_dict&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;parameters_syn&#39;</span> <span class="ow">and</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> \
                    <span class="s1">&#39;idx_synpop_oi_for_fp&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]:</span>
                <span class="n">free_param_val_label</span> <span class="o">=</span> <span class="s1">&#39;fpv </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                       <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;idx_synpop_oi_for_fp&#39;</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;free_parameter_dict&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;input_current&#39;</span><span class="p">:</span>
                <span class="n">free_param_val_label</span> <span class="o">=</span> <span class="s1">&#39;fpv </span><span class="si">%.3f</span><span class="s1"> ?&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">free_param_val_label</span> <span class="o">=</span> <span class="s1">&#39;fpv ?&#39;</span>
            <span class="n">h_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">-</span> <span class="n">t_offset_ms</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">),</span> <span class="n">clip_on</span><span class="o">=</span><span class="n">b_clipon</span><span class="p">,</span>
                                           <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">mon</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_runs</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="n">free_param_val_label</span><span class="p">,</span>
                                           <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth_traces</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># plot marker at maximum / minimum voltage</span>
            <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                <span class="n">i_inital_timepoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">&gt;=</span> <span class="n">find_max_min_from_ms</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">initial_voltage</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_inital_timepoint</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                <span class="n">max_voltage_after_initial_timepoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_inital_timepoint</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                <span class="n">min_voltage_after_initial_timepoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_inital_timepoint</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">max_voltage_after_initial_timepoint</span> <span class="o">&gt;</span> <span class="n">initial_voltage</span> <span class="o">+</span> <span class="mf">0.04</span><span class="p">:</span>  <span class="c1"># 0.04: min diff to be considered peak</span>
                    <span class="n">i_max_v</span> <span class="o">=</span> <span class="n">i_inital_timepoint</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_inital_timepoint</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                    <span class="n">t_max_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_max_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="n">max_voltage_after_initial_timepoint</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="n">max_voltage_after_initial_timepoint</span><span class="p">,</span> <span class="s1">&#39;  ttp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                    <span class="s1">&#39;ms, amp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">max_voltage_after_initial_timepoint</span> <span class="o">-</span> <span class="n">initial_voltage</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                    <span class="s1">&#39;mV&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_max_v</span><span class="p">,</span>
                                                                    <span class="n">i_inital_timepoint</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_25_percent</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span> <span class="o">+</span> <span class="n">find_max_min_from_ms</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span> <span class="o">+</span> <span class="n">find_max_min_from_ms</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span>
                                    <span class="s1">&#39;  25</span><span class="si">% r</span><span class="s1">t: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">min_voltage_after_initial_timepoint</span> <span class="o">&lt;</span> <span class="n">initial_voltage</span> <span class="o">-</span> <span class="mf">0.04</span><span class="p">:</span>  <span class="c1"># 0.04: min diff to be considered peak</span>
                    <span class="n">i_min_v</span> <span class="o">=</span> <span class="n">i_inital_timepoint</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_inital_timepoint</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                    <span class="n">t_min_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_min_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="n">min_voltage_after_initial_timepoint</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="n">min_voltage_after_initial_timepoint</span><span class="p">,</span> <span class="s1">&#39;  ttp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                    <span class="s1">&#39;ms, amp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">min_voltage_after_initial_timepoint</span> <span class="o">-</span> <span class="n">initial_voltage</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                                    <span class="s1">&#39;mV&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_min_v</span><span class="p">,</span>
                                                                    <span class="n">i_inital_timepoint</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_25_percent</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span> <span class="o">+</span> <span class="n">find_max_min_from_ms</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span> <span class="o">+</span> <span class="n">find_max_min_from_ms</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span>
                                    <span class="s1">&#39;  25</span><span class="si">% r</span><span class="s1">t: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

        <span class="c1"># set x lim and x label, show y-axis also on right and add legend</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelright</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_legend</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i_ax</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;free_parameter_name&#39;</span><span class="p">],</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>

    <span class="c1"># disable x label for all but bottom subplot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="plot_spikes_mod"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_spikes_mod">[docs]</a><span class="k">def</span> <span class="nf">plot_spikes_mod</span><span class="p">(</span><span class="n">spikemons</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">b_circuit_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_circuit_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_circuit_probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_circuit_idx</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot spiketimes of all model neurons with one subplot per population.</span>

<span class="sd">    :param spikemons: (list of) brian2 SpikeMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type spikemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param dot_size: [default=2] size for spike markers in dot raster plot</span>
<span class="sd">    :type dot_size: int or float</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param b_circuit_weight: [default=True] plot synaptic weight values next to connecting lines in circuit diagram</span>
<span class="sd">    :type b_circuit_weight: bool</span>
<span class="sd">    :param b_circuit_delay: [default=True] plot synaptic delay values next to connecting lines</span>
<span class="sd">    :type b_circuit_delay: bool</span>
<span class="sd">    :param b_circuit_probability: [default=True] plot synaptic connection probability values next to connecting lines</span>
<span class="sd">    :type b_circuit_probability: bool</span>
<span class="sd">    :param b_circuit_idx: [default=True] plot synapse index next to connecting lines</span>
<span class="sd">    :type b_circuit_idx: bool</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle(s)</span>
<span class="sd">        - axes: axis handles, one sublist per figure</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: [matplotlib.figure.Figure]</span>
<span class="sd">        - axes: [[matplotlib.axes._subplots.AxesSubplot]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if spikemons and info contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">spikemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">spikemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">spikemonitor</span><span class="o">.</span><span class="n">SpikeMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">),</span> \
        <span class="s2">&quot;spikemons must be a list of b2.SpikeMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;spikemons and info must have the same number of elements&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">if</span> <span class="n">n_figs</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: More than 20 figures are about to be created...&quot;</span><span class="p">)</span>

    <span class="c1"># loop through list of spike monitors</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_figs</span><span class="p">):</span>
        <span class="c1"># create figure and set up grid for subplots</span>
        <span class="n">n_populations</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;n_populations&#39;</span><span class="p">]</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">n_populations</span>
        <span class="n">fig_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_tmp</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">):</span>
            <span class="c1"># set up subplot</span>
            <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">pop</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; nrn_idx&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spike times of all neurons&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="c1"># go through neurons and plot all spikes for each neuron</span>
            <span class="n">spiketimes</span> <span class="o">=</span> <span class="n">fcn</span><span class="o">.</span><span class="n">p_util</span><span class="o">.</span><span class="n">get_spiketimes_from_monitor</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">pop</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes</span><span class="p">)):</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spiketimes</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="p">[</span><span class="n">nrn</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
            <span class="c1"># add right hand axis for population size and set y-axis limits</span>
            <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;n = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">]))</span>
            <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># share x axis (time) among all horizontal plots</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># disable x tick labels for voltage trace plots and autoscale all axes</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># other settings</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>

        <span class="c1"># plot network diagram in right grid column</span>
        <span class="n">axis_net</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_gridcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_net</span><span class="p">)</span>
        <span class="n">plot_circuit_diagram</span><span class="p">(</span><span class="n">axis_net</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">b_weight</span><span class="o">=</span><span class="n">b_circuit_weight</span><span class="p">,</span> <span class="n">b_delay</span><span class="o">=</span><span class="n">b_circuit_delay</span><span class="p">,</span>
                             <span class="n">b_probability</span><span class="o">=</span><span class="n">b_circuit_probability</span><span class="p">,</span> <span class="n">b_syn_idx</span><span class="o">=</span><span class="n">b_circuit_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_burst_onsets"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_burst_onsets">[docs]</a><span class="k">def</span> <span class="nf">plot_burst_onsets</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">,</span> <span class="n">offset_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param spiketimes_ms: list of lists of lists of spike times of the neurons (sublist: neuron, subsublist: trial)</span>
<span class="sd">    :type spiketimes_ms: [[float]]</span>
<span class="sd">    :param offset_ms: [default=0] list of recording offsets, one per neuron</span>
<span class="sd">    :type offset_ms: list</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset_ms</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">offset_ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">offset_ms</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_neurons</span>

    <span class="n">n_gridrows</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

    <span class="c1"># get times of first spike</span>
    <span class="n">t_first_spike_nrn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t_first_spike_avg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">t_first_spike_std</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">spikes_nrn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">):</span>
        <span class="n">t_first_spike_nrn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">spikes_trial</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spikes_nrn</span><span class="p">):</span>
            <span class="c1"># NOTE: hardcoded criterion to exclude post-call spikes (100ms after call onset)</span>
            <span class="k">if</span> <span class="n">spikes_trial</span> <span class="ow">and</span> <span class="n">spikes_trial</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">offset_ms</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">t_first_spike_nrn</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spikes_trial</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t_first_spike_avg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_first_spike_nrn</span><span class="p">[</span><span class="n">n</span><span class="p">])</span> <span class="o">-</span> <span class="n">offset_ms</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="n">t_first_spike_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">t_first_spike_nrn</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
    <span class="n">idx_nrn_sort_by_tfs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">t_first_spike_avg</span><span class="p">)</span>

    <span class="c1"># plot onsets of first spike for each neuron and trial</span>
    <span class="n">row_t</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># row counter for trials from all neurons</span>
    <span class="n">row_n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># row counter for trials from all neurons</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Dark2&#39;</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_nrn_sort_by_tfs</span><span class="p">):</span>
        <span class="n">row_n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">spikes_nrn</span> <span class="o">=</span> <span class="n">spiketimes_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">row_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">spikes_trial</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spikes_nrn</span><span class="p">):</span>
            <span class="n">row_t</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spike</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spikes_trial</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;neuron: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nrn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="c1"># plot all spikes of current trial in one row</span>
                <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">spike</span> <span class="o">-</span> <span class="n">offset_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="n">spike</span> <span class="o">-</span> <span class="n">offset_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="p">(</span><span class="n">row_t</span><span class="p">,</span> <span class="n">row_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">nrn</span><span class="o">/</span><span class="n">n_neurons</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="c1"># axes[0].set_xlim((-100, 150))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">row_t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;all spikes per trial&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>

    <span class="c1"># plot first spike of each trial in the same row for all trials of one neuron</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_nrn_sort_by_tfs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">first_spike_trial</span> <span class="ow">in</span> <span class="n">t_first_spike_nrn</span><span class="p">[</span><span class="n">nrn</span><span class="p">]:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">first_spike_trial</span> <span class="o">-</span> <span class="n">offset_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="n">first_spike_trial</span> <span class="o">-</span> <span class="n">offset_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                         <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">nrn</span> <span class="o">/</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_nrn_sort_by_tfs</span><span class="p">):</span>
        <span class="c1"># plot the standard deviation</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">t_first_spike_avg</span><span class="p">[</span><span class="n">nrn</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_first_spike_std</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span>
                      <span class="n">t_first_spike_avg</span><span class="p">[</span><span class="n">nrn</span><span class="p">]</span> <span class="o">+</span> <span class="n">t_first_spike_std</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span>
                     <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># plot the average</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_first_spike_avg</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                     <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># axes[1].set_xlim((-100, 150))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time from call onset [ms]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;first spike in each</span><span class="se">\n</span><span class="s1">trial per neuron&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_t_first_spike_1d"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_t_first_spike_1d">[docs]</a><span class="k">def</span> <span class="nf">plot_t_first_spike_1d</span><span class="p">(</span><span class="n">spikemons</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">neuron_idx_abs</span><span class="p">,</span> <span class="n">param_index_y</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                          <span class="n">idx_mons_colored</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_unit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the timepoint in the simulation when a neuron fires its first spike in dependence on the</span>
<span class="sd">    free parameter.</span>

<span class="sd">    :param spikemons: (list of) brian2 SpikeMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type spikemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param config: dictionary as loaded from .json configuration file</span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param neuron_idx_abs: absoluteindex of the neuron whose spike time is to be plotted</span>
<span class="sd">    :type neuron_idx_abs: int</span>
<span class="sd">    :param param_index_y: index to the values (synapse or population) of the free parameter - for y-axis in the plot</span>
<span class="sd">    :type param_index_y: int</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint of an event in milliseconds. Marker will be drawn at 0 and</span>
<span class="sd">        all spiketimes will be negatively offset by this value.</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param dot_size: size for points in plot</span>
<span class="sd">    :type dot_size: int or float</span>
<span class="sd">    :param idx_mons_colored: list of indices to monitors (runs) for which dots should be emphasized by color</span>
<span class="sd">    :type: list or None</span>
<span class="sd">    :param colors: list of color values for the emphasized monitors, same length as idx_mons_colored</span>
<span class="sd">    :type: list or None</span>
<span class="sd">    :param param_unit: brian2 unit (e.g. brian2.pA) in which to display the free parameter (y-axis). if None, use the</span>
<span class="sd">        unit as stated in config[&#39;parameter_units&#39;].</span>
<span class="sd">    :type param_unit: brian2.units.fundamentalunits.Unit or None</span>
<span class="sd">    :param h_ax: handle to the axis in which the psths are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axis: axis handle</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axis: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if spikemons and info contain a single object (dictionary), convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">spikemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">spikemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">spikemonitor</span><span class="o">.</span><span class="n">SpikeMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">),</span> \
        <span class="s2">&quot;spikemons must be a list of b2.SpikeMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="s2">&quot;statemons, spikemons and info must all have the same number of elements&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_index_y</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;param_index_y must be an integer&quot;</span>

    <span class="c1"># if neuron_idx_abs is a negative number, translate that to a positive index</span>
    <span class="k">if</span> <span class="n">neuron_idx_abs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">neuron_idx_abs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">neuron_idx_abs</span>

    <span class="c1"># get name of free parameter, stepsize and dict containing it e.g. &quot;parameters_nrn&quot;; if the config file contains one</span>
    <span class="c1"># restricted to one param atm!</span>
    <span class="n">free_parameter_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;free_parameter_stepsize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">free_parameter_keys</span><span class="p">:</span>
        <span class="n">free_parameter_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">free_parameter_name</span> <span class="o">=</span> <span class="n">free_parameter_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters_nrn&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;parameters_nrn&#39;</span>
        <span class="k">elif</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters_syn&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;parameters_syn&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;parameters_gen&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters_gen&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;parameters_gen&#39;</span>
        <span class="k">elif</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_current&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;input_current&#39;</span>

    <span class="c1"># get times of first spike</span>
    <span class="n">spike_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">))</span>
    <span class="n">y_values_run</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)):</span>
        <span class="c1"># get value of free parameter in this run. if a parameter unit was passed, apply that</span>
        <span class="n">unitless_param_value</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">]</span>
        <span class="c1"># if this is a list (happens e.g. when free param is t_start), just use the last entry (quick fix)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unitless_param_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">unitless_param_value</span> <span class="o">=</span> <span class="n">unitless_param_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameter_units&#39;</span><span class="p">]:</span>
            <span class="n">original_unit</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameter_units&#39;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_name&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">param_unit</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b2</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="n">original_unit</span><span class="p">):</span>
                <span class="n">y_values_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unitless_param_value</span> <span class="o">*</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;b2.&#39;</span> <span class="o">+</span> <span class="n">original_unit</span><span class="p">)</span> <span class="o">/</span> <span class="n">param_unit</span><span class="p">)</span>
                <span class="n">y_unit_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">param_unit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plot_t_first_spike_1d(): Unrecognized free param unit &#39;&quot;</span> <span class="o">+</span> <span class="n">original_unit</span> <span class="o">+</span> <span class="s2">&quot;&#39; in cfg&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_values_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unitless_param_value</span><span class="p">)</span>
            <span class="n">y_unit_str</span> <span class="o">=</span> <span class="n">original_unit</span>
        <span class="n">idx_first_spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">neuron_idx_abs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_first_spike</span><span class="p">]):</span>
            <span class="n">spike_time</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span> <span class="o">=</span> <span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_first_spike</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
    <span class="c1"># set values NaN where no spike occured</span>
    <span class="n">spike_time</span><span class="p">[</span><span class="n">spike_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># plot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">h_ax</span>
    <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">spike_time</span> <span class="o">=</span> <span class="n">spike_time</span> <span class="o">-</span> <span class="n">t_const_event_marker</span>
    <span class="n">i_color</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">idx_mons_colored</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">colors</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_mons_colored</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_time</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">idx_mons_colored</span> <span class="ow">and</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">idx_mons_colored</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_time</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_values_run</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i_color</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
            <span class="n">i_color</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spike_time</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">y_values_run</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>

    <span class="c1"># set axis ticks to parameter values, and other settings</span>
    <span class="n">stepsize</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y_values_run</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_values_run</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">y_values_run</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_values_run</span><span class="p">)</span> <span class="o">+</span> <span class="n">stepsize</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t first spike [ms]&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">free_parameter_name</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">param_index_y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) [&#39;</span> <span class="o">+</span> <span class="n">y_unit_str</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

    <span class="c1"># set title (if synaptic parameter, include pre-synaptic and post-synaptic population ids in title)</span>
    <span class="k">if</span> <span class="n">free_parameter_dict</span> <span class="o">==</span> <span class="s1">&#39;parameters_syn&#39;</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time of first spike for neuron &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">neuron_idx_abs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; by &#39;</span> <span class="o">+</span> <span class="n">free_parameter_name</span> <span class="o">+</span>
                       <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;syn_pre_idx&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39; -&gt; &#39;</span> <span class="o">+</span>
                       <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;syn_post_idx&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="c1"># if all free parameter values are negative, invert direction of y-axis</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">y_values_run</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_values_run</span><span class="p">))]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">free_parameter_dict</span> <span class="o">==</span> <span class="s1">&#39;parameters_nrn&#39;</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time of first spike for neuron &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">neuron_idx_abs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; by &#39;</span> <span class="o">+</span> <span class="n">free_parameter_name</span> <span class="o">+</span>
                       <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Time of first spike for neuron &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">neuron_idx_abs</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; by &#39;</span> <span class="o">+</span>
                       <span class="n">free_parameter_name</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="plot_t_first_spike_1d_jamming"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_t_first_spike_1d_jamming">[docs]</a><span class="k">def</span> <span class="nf">plot_t_first_spike_1d_jamming</span><span class="p">(</span><span class="n">spikemons</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">neuron_idx_abs</span><span class="p">,</span> <span class="n">param_index_y</span><span class="p">,</span> <span class="n">idx_t_start</span><span class="p">,</span>
                                  <span class="n">lat_playback_onset_to_t_start</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dot_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">marker_linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">idx_mons_colored</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the timepoint in the simulation when a neuron fires its first spike in dependence on the</span>
<span class="sd">    free parameter. Compared to plot_t_first_spike_1d(), x- and y-axis are switched and x-axis is reversed. If,</span>
<span class="sd">    for example the free parameter is a timing parameter (e.g. input current t_start), this switches the relation, i.e.</span>
<span class="sd">    shows the delay of the neuron of interest spike from the point of view of its own spike relative to t_start (x-axis)</span>
<span class="sd">    instead of from the point of view of t_start in relation to its own spike.</span>

<span class="sd">    :param spikemons: (list of) brian2 SpikeMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type spikemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param config: dictionary as loaded from .json configuration file</span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param neuron_idx_abs: absolute index of the neuron whose spike time is to be plotted</span>
<span class="sd">    :type neuron_idx_abs: int</span>
<span class="sd">    :param param_index_y: index to the values (synapse or population) of the free parameter - for y-axis in the plot</span>
<span class="sd">    :type param_index_y: int</span>
<span class="sd">    :param idx_t_start: index to the value of t_start that is changing as a free parameter (e.g. start of ramp)</span>
<span class="sd">    :type idx_t_start: int</span>
<span class="sd">    :param lat_playback_onset_to_t_start: time in ms between supposed playback onset and t_start value at idx_t_start.</span>
<span class="sd">        adjusts x-axis values</span>
<span class="sd">    :type lat_playback_onset_to_t_start: int</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param dot_size: size for points in plot</span>
<span class="sd">    :type dot_size: int or float</span>
<span class="sd">    :param marker_linestyle: linestyle for event marker (default: &#39;--&#39; = dashed line)</span>
<span class="sd">    :type marker_linestyle: str</span>
<span class="sd">    :param idx_mons_colored: list of indices to monitors (runs) for which dots should be emphasized by color</span>
<span class="sd">    :type: list or None</span>
<span class="sd">    :param colors: list of color values for the emphasized monitors, same length as idx_mons_colored</span>
<span class="sd">    :type: list or None</span>
<span class="sd">    :param h_ax: handle to the axis in which the psths are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axis: axis handle</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axis: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if spikemons and info contain a single object (dictionary), convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">spikemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">spikemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">spikemonitor</span><span class="o">.</span><span class="n">SpikeMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">),</span> \
        <span class="s2">&quot;spikemons must be a list of b2.SpikeMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="s2">&quot;statemons, spikemons and info must all have the same number of elements&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">param_index_y</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;param_index_y must be an integer&quot;</span>

    <span class="c1"># if neuron_idx_abs is a negative number, translate that to a positive index</span>
    <span class="k">if</span> <span class="n">neuron_idx_abs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">neuron_idx_abs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">neuron_idx_abs</span>

    <span class="c1"># get name of free parameter, stepsize and dict containing it e.g. &quot;parameters_nrn&quot;; if the config file contains one</span>
    <span class="c1"># restricted to one param atm!</span>
    <span class="n">free_parameter_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;free_parameter_stepsize&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">free_parameter_keys</span><span class="p">:</span>
        <span class="n">free_parameter_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">free_parameter_stepsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">free_parameter_name</span> <span class="o">=</span> <span class="n">free_parameter_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">free_parameter_stepsize</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;free_parameter_stepsize&#39;</span><span class="p">][</span><span class="n">free_parameter_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters_nrn&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;parameters_nrn&#39;</span>
        <span class="k">elif</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters_syn&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;parameters_syn&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;parameters_gen&#39;</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">and</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters_gen&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;parameters_gen&#39;</span>
        <span class="k">elif</span> <span class="n">free_parameter_name</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_current&#39;</span><span class="p">]:</span>
            <span class="n">free_parameter_dict</span> <span class="o">=</span> <span class="s1">&#39;input_current&#39;</span>

    <span class="c1"># get bounds of values for free parameter</span>
    <span class="n">lower_bounds</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">free_parameter_dict</span><span class="p">][</span><span class="n">free_parameter_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upper_bounds</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">free_parameter_dict</span><span class="p">][</span><span class="n">free_parameter_name</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">lower_bound_y</span> <span class="o">=</span> <span class="n">lower_bounds</span><span class="p">[</span><span class="n">param_index_y</span><span class="p">]</span>
    <span class="n">upper_bound_y</span> <span class="o">=</span> <span class="n">upper_bounds</span><span class="p">[</span><span class="n">param_index_y</span><span class="p">]</span>

    <span class="c1"># if the bounds contain a list, take the first value of that list (e.g. for input_current:t_start)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lower_bound_y</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">lower_bound_y</span> <span class="o">=</span> <span class="n">lower_bound_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">upper_bound_y</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">upper_bound_y</span> <span class="o">=</span> <span class="n">upper_bound_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># get all values of free parameter for x- and y-axis</span>
    <span class="n">difference_y</span> <span class="o">=</span> <span class="n">upper_bound_y</span> <span class="o">-</span> <span class="n">lower_bound_y</span>

    <span class="c1"># get times of first spike</span>
    <span class="n">spike_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">))</span>
    <span class="n">y_values_run</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)):</span>
        <span class="c1"># get value of free parameter in this run</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">y_values_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">][</span><span class="n">idx_t_start</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_values_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="n">param_index_y</span><span class="p">])</span>
        <span class="n">idx_spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">neuron_idx_abs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># convert values back to milliseconds</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_spikes</span><span class="p">]):</span>
            <span class="n">spike_time</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span> <span class="o">=</span> <span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">idx_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
    <span class="c1"># set values NaN where no spike ocurred</span>
    <span class="n">spike_time</span><span class="p">[</span><span class="n">spike_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># time of first spike without inhibition (last entry, should be where inhibition ramp starts after first spike)</span>
    <span class="n">t_first_spike_no_inhibition</span> <span class="o">=</span> <span class="n">spikemons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">neuron_idx_abs</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>

    <span class="c1"># prepare plot</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.42</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">h_ax</span>

    <span class="c1"># plot markers, dots and crosses where the neuron didn&#39;t spike at all</span>
    <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">marker_linestyle</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_first_spike_no_inhibition</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_values_run</span><span class="p">)</span> <span class="o">+</span> <span class="n">lat_playback_onset_to_t_start</span><span class="p">,</span>
              <span class="n">spike_time</span> <span class="o">-</span> <span class="n">t_first_spike_no_inhibition</span><span class="p">,</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
    <span class="n">i_no_spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spike_time</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_first_spike_no_inhibition</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_values_run</span><span class="p">)[</span><span class="n">i_no_spike</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_playback_onset_to_t_start</span><span class="p">,</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_no_spike</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">idx_mons_colored</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">colors</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx_mons_colored</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx_mons_colored</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spike_time</span><span class="p">[</span><span class="n">m</span><span class="p">]):</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_first_spike_no_inhibition</span> <span class="o">-</span> <span class="n">y_values_run</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_playback_onset_to_t_start</span><span class="p">,</span>
                          <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_first_spike_no_inhibition</span> <span class="o">-</span> <span class="n">y_values_run</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span> <span class="n">lat_playback_onset_to_t_start</span><span class="p">,</span>
                          <span class="n">spike_time</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_first_spike_no_inhibition</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>

    <span class="c1"># set axis ticks to parameter values, and other settings</span>
    <span class="c1"># stepsize = abs(y_values_run[1] - y_values_run[0])</span>
    <span class="c1"># axis.set_xlim(min(y_values_run) - stepsize, max(y_values_run) + stepsize)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;PM burst relative to playback onset [ms]&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PM burst delay [ms]&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;regular&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="plot_connection_matrix"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_connection_matrix">[docs]</a><span class="k">def</span> <span class="nf">plot_connection_matrix</span><span class="p">(</span><span class="n">connectivity</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matrix plots of the synaptic connections between the neurons of two populations (one figure per population pair)</span>

<span class="sd">    :param connectivity: dictionary or list of dictionaries containing synaptic connectivity information</span>
<span class="sd">        (one dict per connection between populations)</span>
<span class="sd">    :type connectivity: dict or list</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (only first dict used)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :return: fig: list of figure handles</span>
<span class="sd">    :rtype: [matplotlib.figure.Figure]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if connectivity and info contain a single object (dictionary), convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">connectivity</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">connectivity</span> <span class="o">=</span> <span class="p">[</span><span class="n">connectivity</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">connectivity</span><span class="p">),</span> \
        <span class="s2">&quot;connectivity must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connectivity</span><span class="p">)):</span>
        <span class="c1"># construct connection matrix from synapse indices (i = pre, j = post)</span>
        <span class="n">idx_pre_pop</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;syn_pre_idx&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">idx_post_pop</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;syn_post_idx&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">pop_sz_pre</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">idx_pre_pop</span><span class="p">]</span>
        <span class="n">pop_sz_post</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">idx_post_pop</span><span class="p">]</span>
        <span class="n">connection_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pop_sz_pre</span><span class="p">,</span> <span class="n">pop_sz_post</span><span class="p">))</span>
        <span class="n">connection_matrix</span><span class="p">[</span><span class="n">connectivity</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">connectivity</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;j&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># set up figure and plot matrix as pixel-perfect figimage</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="n">y_pixels</span> <span class="o">=</span> <span class="n">pop_sz_pre</span>
        <span class="n">x_pixels</span> <span class="o">=</span> <span class="n">pop_sz_post</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">x_pixels</span><span class="o">/</span><span class="n">dpi</span><span class="p">,</span> <span class="n">y_pixels</span><span class="o">/</span><span class="n">dpi</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">figimage</span><span class="p">(</span><span class="n">connection_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cividis&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="plot_connection_matrix_generator"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_connection_matrix_generator">[docs]</a><span class="k">def</span> <span class="nf">plot_connection_matrix_generator</span><span class="p">(</span><span class="n">connectivity_generator</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matrix plots of the synaptic connections between the neurons of two populations (one figure per population pair)</span>

<span class="sd">    :param connectivity_generator: dictionary or list of dictionaries containing spikegenerator connectivity information</span>
<span class="sd">        (one dict per connection between spikegenerator and population)</span>
<span class="sd">    :type connectivity_generator: dict or list</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (only first dict used)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :return: fig: list of figure handles</span>
<span class="sd">    :rtype: [matplotlib.figure.Figure]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># todo: does probably not work with unequal generator and population sizes. likely unnecessary anyway due to</span>
    <span class="c1"># (todo cont) selective loading of spiketimes thorugh p_input.load_spiketimes_for_gen</span>

    <span class="c1"># if connectivity_generator and info contain a single object (dictionary), convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">connectivity_generator</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">connectivity_generator</span> <span class="o">=</span> <span class="p">[</span><span class="n">connectivity_generator</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">connectivity_generator</span><span class="p">),</span> \
        <span class="s2">&quot;connectivity_generator must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connectivity_generator</span><span class="p">)):</span>
        <span class="c1"># construct connection matrix from synapse indices (i = pre, j = post)</span>
        <span class="n">pop_sz_pre</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;generator_sizes&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">pop_sz_post</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">connection_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pop_sz_pre</span><span class="p">,</span> <span class="n">pop_sz_post</span><span class="p">))</span>
        <span class="n">connection_matrix</span><span class="p">[</span><span class="n">connectivity_generator</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;i&#39;</span><span class="p">],</span> <span class="n">connectivity_generator</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;j&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># set up figure and plot matrix as pixel-perfect figimage</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="mf">80.</span>
        <span class="n">y_pixels</span> <span class="o">=</span> <span class="n">pop_sz_pre</span>
        <span class="n">x_pixels</span> <span class="o">=</span> <span class="n">pop_sz_post</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">x_pixels</span><span class="o">/</span><span class="n">dpi</span><span class="p">,</span> <span class="n">y_pixels</span><span class="o">/</span><span class="n">dpi</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">dpi</span><span class="p">)))</span>
        <span class="n">fig</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">figimage</span><span class="p">(</span><span class="n">connection_matrix</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;cividis&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="plot_sensitivity_traces"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_sensitivity_traces">[docs]</a><span class="k">def</span> <span class="nf">plot_sensitivity_traces</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">spikemons</span><span class="p">,</span> <span class="n">infos</span><span class="p">,</span> <span class="n">config_lo</span><span class="p">,</span> <span class="n">conditions_met</span><span class="p">,</span> <span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">baseline_cond</span><span class="p">,</span>
                            <span class="n">t_baseline</span><span class="p">,</span> <span class="n">t_spikes</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Generate 2d matrix of subplots of traces in parameter space of two varied parameters, that visualizes where</span>
<span class="sd">    certain conditions are met. Run p_analysis.check_conditions() first.</span>

<span class="sd">    :param statemons: list of dict(s) containing StateMonitor data from b2...get_states()</span>
<span class="sd">    :type statemons: list</span>
<span class="sd">    :param spikemons: list of dict(s) containing SpikeMonitor data from b2...get_states()</span>
<span class="sd">    :type spikemons: list</span>
<span class="sd">    :param infos: list of dict(s) containing additional information about simulation (as created by run_simulation())</span>
<span class="sd">    :type infos: list</span>
<span class="sd">    :param config_lo: config dict as loaded from .json file (output directory), contains lower limits of all params</span>
<span class="sd">    :type config_lo: dict</span>
<span class="sd">    :param conditions_met: numpy array of dimension c*x*y as returned by p_analysis.check_conditions()</span>
<span class="sd">    :type conditions_met: numpy.ndarray</span>
<span class="sd">    :param x_values: values of the first varied parameter (usually last parameter in cfg list), used for x-tick-labels</span>
<span class="sd">    :type x_values: list</span>
<span class="sd">    :param y_values: values of the second varied parameter (usually first parameter in cfg list), used for y-tick-labels</span>
<span class="sd">    :type y_values: list</span>
<span class="sd">    :param baseline_cond: condition for baseline membrane potential. tuple of lower and upper limit for condition to</span>
<span class="sd">        be considered met.</span>
<span class="sd">    :type baseline_cond: tuple or list</span>
<span class="sd">    :param t_baseline: time window in which the baseline membrane potential condition was checked (start, end)</span>
<span class="sd">    :type t_baseline: tuple or list</span>
<span class="sd">    :param t_spikes: time window in which the number of spikes condition was checked (start, end)</span>
<span class="sd">    :type t_spikes: tuple or list</span>
<span class="sd">    :param xlabel: x-axis label</span>
<span class="sd">    :type xlabel: str</span>
<span class="sd">    :param ylabel: y-axis label</span>
<span class="sd">    :type ylabel: str</span>
<span class="sd">    :param xlims: x-axis limits (lower, upper)</span>
<span class="sd">    :type xlims: tuple or list</span>
<span class="sd">    :param figsize: size of figure in inches (width, height)</span>
<span class="sd">    :type figsize: tuple or list</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axes: list of axis handles</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axes: [matplotlib.axes._subplots.AxesSubplot]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="n">conditions_met</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">conditions_met</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># loop through sims and plot trace</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_gridcols</span><span class="p">):</span>
            <span class="c1"># get index to neuron of interest</span>
            <span class="n">nrn_oi_abs</span> <span class="o">=</span> <span class="n">p_util</span><span class="o">.</span><span class="n">get_abs_from_rel_nrn_idx</span><span class="p">(</span><span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;idx_nrn_oi_relative&#39;</span><span class="p">],</span>
                                                         <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">][</span><span class="s1">&#39;idx_pop_oi&#39;</span><span class="p">],</span>
                                                         <span class="n">infos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
            <span class="c1"># plot rectangle for number of spikes condition</span>
            <span class="k">if</span> <span class="n">conditions_met</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span>
                                <span class="n">t_spikes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_spikes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span>
                                <span class="n">t_spikes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">))</span>
            <span class="c1"># plot rectangle for baseline membrane potential condition</span>
            <span class="k">if</span> <span class="n">conditions_met</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">t_baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span> <span class="n">baseline_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                <span class="n">t_baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">baseline_cond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">t_baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span> <span class="n">baseline_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                <span class="n">t_baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">baseline_cond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline_cond</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">)))</span>
            <span class="c1"># plot trace</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span>
                     <span class="n">statemons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn_oi_abs</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="c1"># plot artificial spikes</span>
            <span class="n">spiketimes</span> <span class="o">=</span> <span class="n">spikemons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">spikemons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">nrn_oi_abs</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">]</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;v_thresh&#39;</span><span class="p">][</span><span class="n">nrn_oi_abs</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes</span><span class="p">)):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">spiketimes</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">spiketimes</span><span class="p">[</span><span class="n">s</span><span class="p">]],</span> <span class="p">[</span><span class="n">thresh</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">+</span> <span class="mi">30</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># add parameter values as axis labels</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
                <span class="n">ax_r</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
                <span class="n">ax_r</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
                <span class="n">ax_r</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">round</span><span class="p">(</span><span class="n">n_gridcols</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">y</span> <span class="o">==</span> <span class="n">n_gridrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">round</span><span class="p">(</span><span class="n">n_gridcols</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlabel</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;Time from call onset [ms]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">n_gridcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
                <span class="n">ax_r</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">ax_r</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
                <span class="n">ax_r</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="nb">round</span><span class="p">(</span><span class="n">n_gridrows</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_values</span><span class="p">[</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">ylabel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax_r</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">y_values</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="nb">round</span><span class="p">(</span><span class="n">n_gridrows</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\mathrm</span><span class="si">{V_m}</span><span class="s1">$ [mV]&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylabel</span><span class="p">())</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># share y-axes</span>
    <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">xlims</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">xl</span> <span class="o">-</span> <span class="n">config_lo</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">xl</span> <span class="ow">in</span> <span class="n">xlims</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">statemons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_circuit_diagram"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_circuit_diagram">[docs]</a><span class="k">def</span> <span class="nf">plot_circuit_diagram</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">info_dict</span><span class="p">,</span> <span class="n">b_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_delay</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_syn_idx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">line_colors</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))):</span>
    <span class="sd">&quot;&quot;&quot;Plot a circuit diagram with each neuron population (in info_dict) represented by a circle and each synaptic</span>
<span class="sd">    connection represented as lines between them with triangles for postive synaptic weights (excitatory) and circles</span>
<span class="sd">    for negative (inhibitory)</span>

<span class="sd">    :param axis: pyplot axis handle in which the circuit diagram should be plotted</span>
<span class="sd">    :type axis: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :param info_dict: dictionary as created by the simulation (e.g. lif.py). Do not pass the list that is saved by</span>
<span class="sd">        the simulation, but only a single element (i.e. dict).</span>
<span class="sd">    :type info_dict: dict</span>
<span class="sd">    :param b_weight: [default=True] plot synaptic weight values next to connecting lines</span>
<span class="sd">    :type b_weight: bool</span>
<span class="sd">    :param b_delay: [default=True] plot synaptic delay values next to connecting lines</span>
<span class="sd">    :type b_delay: bool</span>
<span class="sd">    :param b_probability: [default=True] plot synaptic connection probability values next to connecting lines</span>
<span class="sd">    :type b_probability: bool</span>
<span class="sd">    :param b_syn_idx: [default=False] plot synapse index next to connecting lines</span>
<span class="sd">    :type b_syn_idx: bool</span>
<span class="sd">    :param line_colors: [default=(1,1,...)] tuple of length==n_synapses, consisting of an index to C_COLORS_GREY</span>
<span class="sd">        (defined in this file) for each synpase, setting the color for the respective connection line. 1 == black</span>
<span class="sd">    :type line_colors: tuple</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get number of populations (i.e. circles in the diagram; can be single neurons)</span>
    <span class="n">n_populations</span> <span class="o">=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;n_populations&#39;</span><span class="p">]</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">n_populations</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">circle_x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_populations</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">circle_radius</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">in_syn_radius</span> <span class="o">=</span> <span class="mf">0.04</span>  <span class="c1"># radius of circle representing inhibitory synapse</span>
    <span class="n">recurrent_radius</span> <span class="o">=</span> <span class="mf">0.11</span>  <span class="c1"># radius of circle representing recurrent connections (population synapsing onto itself)</span>
    <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">)</span>
    <span class="n">color_map_grey</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_populations</span><span class="p">):</span>
        <span class="c1"># plot a circle representing each population next to its voltage trace (circle y = index of pop: 0, 1, ...)</span>
        <span class="n">circle_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">pop</span><span class="p">),</span> <span class="n">circle_radius</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle_tmp</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">pop</span><span class="p">,</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1"># plot population name</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">pop</span><span class="p">,</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">pop</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="c1"># loop through indices of the synapses in which the population is the pre-synaptic population</span>
        <span class="n">i_pop_is_pre</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_pre_idx&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">pop</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">syn</span> <span class="ow">in</span> <span class="n">i_pop_is_pre</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_post_idx&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span>  <span class="c1"># index of post-synaptic population at current synapse</span>
            <span class="c1"># check if the synapse connects the population to itself; if so, plot circle to represent connection</span>
            <span class="k">if</span> <span class="n">post</span> <span class="o">==</span> <span class="n">pop</span><span class="p">:</span>  <span class="c1"># connection from one population onto itself</span>
                <span class="n">circle_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span> <span class="o">+</span> <span class="n">circle_radius</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">pop</span><span class="p">),</span> <span class="n">recurrent_radius</span><span class="p">,</span>
                                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">color_map_grey</span><span class="p">[</span><span class="n">line_colors</span><span class="p">[</span><span class="n">syn</span><span class="p">]],</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle_tmp</span><span class="p">)</span>
                <span class="c1"># add text to line displaying synaptic weight and delay as well as legend text on bottom of axis</span>
                <span class="n">next_to_nrn</span> <span class="o">=</span> <span class="p">[</span><span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span> <span class="o">+</span> <span class="n">circle_radius</span> <span class="o">+</span> <span class="n">recurrent_radius</span><span class="o">*</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">pop</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">b_weight</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_weight&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">],</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b_delay</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_delay&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b_probability</span> <span class="ow">and</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;connection_probability&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;connection_probability&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]),</span>
                             <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="c1"># add text for synaptic index next to line</span>
                <span class="k">if</span> <span class="n">b_syn_idx</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_to_nrn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">syn</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_grey</span><span class="p">[</span><span class="n">line_colors</span><span class="p">[</span><span class="n">syn</span><span class="p">]])</span>
                <span class="c1"># plot an arrow (head) to represent an excitatory synapse, a circle to represent an inhibitory synapse</span>
                <span class="k">if</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_weight&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">arrow_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">circle_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">.</span><span class="mi">48</span><span class="p">),</span> <span class="n">circle_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">.</span><span class="mi">48</span><span class="p">)]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">],</span> <span class="n">post</span><span class="p">,</span> <span class="n">arrow_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="n">arrow_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span>
                              <span class="n">head_width</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_weight&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">circle_dist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">circle_radius</span> <span class="o">+</span> <span class="n">in_syn_radius</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">.</span><span class="mi">48</span><span class="p">),</span>
                                   <span class="p">(</span><span class="n">circle_radius</span> <span class="o">+</span> <span class="n">in_syn_radius</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">.</span><span class="mi">48</span><span class="p">)]</span>
                    <span class="n">circle_in_syn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">]</span> <span class="o">+</span> <span class="n">circle_dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="n">post</span> <span class="o">+</span> <span class="n">circle_dist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">),</span>
                        <span class="n">in_syn_radius</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle_in_syn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># connections between two populations</span>
                <span class="c1"># plot a line connecting circles for each synapse</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">],</span> <span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">]],</span> <span class="p">[</span><span class="n">pop</span><span class="p">,</span> <span class="n">post</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_grey</span><span class="p">[</span><span class="n">line_colors</span><span class="p">[</span><span class="n">syn</span><span class="p">]],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># get angle of line connecting populations</span>
                <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pop</span> <span class="o">-</span> <span class="n">post</span><span class="p">,</span> <span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span> <span class="o">-</span> <span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">])</span>
                <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>
                <span class="c1"># add text to line displaying synaptic weight and delay as well as legend text on bottom of axis</span>
                <span class="n">between_nrns</span> <span class="o">=</span> <span class="p">[</span><span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">]</span> <span class="o">-</span> <span class="n">circle_x</span><span class="p">[</span><span class="n">pop</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="n">pop</span> <span class="o">+</span> <span class="p">(</span><span class="n">post</span> <span class="o">-</span> <span class="n">pop</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">b_weight</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">between_nrns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">between_nrns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_weight&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">],</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">rotation</span><span class="o">=-</span><span class="n">angle_deg</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b_delay</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">between_nrns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">between_nrns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_delay&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">rotation</span><span class="o">=-</span><span class="n">angle_deg</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b_probability</span> <span class="ow">and</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;connection_probability&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">between_nrns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">between_nrns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;connection_probability&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]),</span>
                             <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=-</span><span class="n">angle_deg</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
                <span class="c1"># add text for synaptic index next to line</span>
                <span class="k">if</span> <span class="n">b_syn_idx</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">between_nrns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">between_nrns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">syn</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">rotation</span><span class="o">=-</span><span class="n">angle_deg</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s1">&#39;anchor&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_grey</span><span class="p">[</span><span class="n">line_colors</span><span class="p">[</span><span class="n">syn</span><span class="p">]])</span>
                <span class="c1"># plot an arrow (head) to represent an excitatory synapse, a circle to represent an inhibitory synapse</span>
                <span class="k">if</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_weight&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">arrow_length</span> <span class="o">=</span> <span class="p">[</span><span class="n">circle_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">),</span> <span class="n">circle_radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)]</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">],</span> <span class="n">post</span><span class="p">,</span> <span class="n">arrow_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="n">arrow_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span>
                              <span class="n">head_width</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;syn_weight&#39;</span><span class="p">][</span><span class="n">syn</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">circle_dist</span> <span class="o">=</span> <span class="p">[(</span><span class="n">circle_radius</span> <span class="o">+</span> <span class="n">in_syn_radius</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">),</span>
                                   <span class="p">(</span><span class="n">circle_radius</span> <span class="o">+</span> <span class="n">in_syn_radius</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)]</span>
                    <span class="n">circle_in_syn</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">circle_x</span><span class="p">[</span><span class="n">post</span><span class="p">]</span> <span class="o">+</span> <span class="n">circle_dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span> <span class="n">post</span> <span class="o">+</span> <span class="n">circle_dist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">),</span>
                                               <span class="n">in_syn_radius</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">circle_in_syn</span><span class="p">)</span>

    <span class="c1"># plot legend text</span>
    <span class="k">if</span> <span class="n">b_weight</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_populations</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;synaptic weight [mV]&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_delay</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_populations</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">.</span><span class="mi">55</span><span class="p">,</span> <span class="s1">&#39;synaptic delay [ms]&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_probability</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_populations</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;connection probability&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

    <span class="c1"># set net axis aspect equal (i.e. resizing figure will not affect shape of axis)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_psths"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_psths">[docs]</a><span class="k">def</span> <span class="nf">plot_psths</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">psths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psths_smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">b_plot_average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">t_baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_peak_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_normalize_rate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_markers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">b_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot multiple peri-stimulus time histograms (psth) into a single figure.</span>

<span class="sd">    :param t_values: (list of) list(s) of time values of psth bins (left value), as returned by p_analysis.get_psth()</span>
<span class="sd">    :type t_values: [float] or [[float]]</span>
<span class="sd">    :param psths: [default=None] (list of) psth(s) as returned by p_analysis.get_psth(). pass either psths,</span>
<span class="sd">        psths_smooth or both</span>
<span class="sd">    :type psths: [float] or [[float]] or None</span>
<span class="sd">    :param psths_smooth: [default=None] list of smoothed psth as returned by p_analysis.get_psth()</span>
<span class="sd">    :type psths_smooth: [float] or [[float]] or None</span>
<span class="sd">    :param labels: [default=None] (list of) string(s) of labels for the different psths (e.g. neurons). Set entries</span>
<span class="sd">        to None to exclude them from the legend (e.g.: [&#39;bla&#39;, None, &#39;bla&#39;])</span>
<span class="sd">    :type labels: str or list or None</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param marker_linestyle: linestyle for event marker (default: &#39;--&#39; = dashed line)</span>
<span class="sd">    :type marker_linestyle: str</span>
<span class="sd">    :param colors: list of color values, one color for each psth</span>
<span class="sd">    :type colors: list or None</span>
<span class="sd">    :param linewidth: (list of) linewidth values, one color for each psth</span>
<span class="sd">    :type linewidth: list or None</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param b_plot_average: [default=False] plot the average of all psths</span>
<span class="sd">    :type b_plot_average: bool</span>
<span class="sd">    :param t_baseline: time interval [beginning, end] during which to calculate average baseline activity.</span>
<span class="sd">    :type t_baseline: list or tuple or None</span>
<span class="sd">    :param t_peak_range: time interval [beginning, end] in which to detect peak activity.</span>
<span class="sd">    :type t_peak_range: list or tuple or None</span>
<span class="sd">    :param b_normalize_rate: if True, psths will be normalized so that baseline activity is 1.</span>
<span class="sd">    :type b_normalize_rate: bool</span>
<span class="sd">    :param b_markers: if True, additional markers will be plotted (baseline, peak, ...)</span>
<span class="sd">    :type b_markers: bool</span>
<span class="sd">    :param b_legend: if True, add legend</span>
<span class="sd">    :type b_legend: bool</span>
<span class="sd">    :param h_ax: handle to the axis in which the psths are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axis: axis handle</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axis: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">t_values</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">,</span> <span class="s2">&quot;t_values must be a (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">psths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psths must be a (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_smooth</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">psths_smooth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psths_smooth must be a (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span>  <span class="s2">&quot;labels must be a (list of) string(s)&quot;</span>
    <span class="c1"># if t_values, psths and/or psths_smooth are a single list, convert them to a list of a list</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">t_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_values</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">psths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">psths</span> <span class="o">=</span> <span class="p">[</span><span class="n">psths</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">psths_smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_smooth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">psths_smooth</span> <span class="o">=</span> <span class="p">[</span><span class="n">psths_smooth</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">b_normalize_rate</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">t_baseline</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_baseline</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;b_normalize_rate is True, but t_baseline not given&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>

    <span class="c1"># create figure and axis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">h_ax</span>
    <span class="k">if</span> <span class="n">psths_smooth</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">psths</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Peri-stimulus-time histogram (smoothed)&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Peri-stimulus-time histogram&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_normalize_rate</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;avg. spike rate rel. to baseline&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;average spike rate [Hz]&#39;</span><span class="p">)</span>

    <span class="c1"># if no labels were passed, set arbitrary labels</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">))]</span>

    <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
    <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">marker_linestyle</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>

    <span class="c1"># get default color cycle and duplicate each entry for psth and psth_smooth if both will be printed</span>
    <span class="k">if</span> <span class="n">psths</span> <span class="ow">and</span> <span class="n">psths_smooth</span><span class="p">:</span>
        <span class="n">default_color_cycle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.prop_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">by_key</span><span class="p">()[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
        <span class="n">idx_dupl_color_cycle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">default_color_cycle</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">default_color_cycle</span><span class="p">[</span><span class="n">idx_dupl_color_cycle</span><span class="p">[</span><span class="n">val</span><span class="p">]]</span>
                                   <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx_dupl_color_cycle</span><span class="p">))])</span>

    <span class="c1"># get baseline interval in samples</span>
    <span class="k">if</span> <span class="n">t_baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">samp_baseline_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">t_baseline</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">samp_baseline_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">t_baseline</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># plot psths</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_x</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">psths_smooth</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">psths</span><span class="p">:</span>
        <span class="n">linestyle_smoothed</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linestyle_smoothed</span> <span class="o">=</span> <span class="s1">&#39;--&#39;</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">colors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">):</span>
            <span class="n">color_cur</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_cur</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab20</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linewidth</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">linewidth</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">):</span>
            <span class="n">linewidth_cur</span> <span class="o">=</span> <span class="n">linewidth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">linewidth_cur</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">psths</span><span class="p">:</span>
            <span class="c1"># get baseline activity</span>
            <span class="k">if</span> <span class="n">t_baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">baseline_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psths</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">samp_baseline_start</span><span class="p">:</span><span class="n">samp_baseline_end</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">b_markers</span><span class="p">:</span>
                    <span class="c1"># mark peak</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">t_peak_range</span><span class="p">:</span>
                        <span class="n">t_peak_range_idx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t_peak_range_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">t_peak_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">t_peak_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">peak_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psths</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">peak_x</span> <span class="o">=</span> <span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">psths</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> \
                                           <span class="o">+</span> <span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_x</span><span class="p">,</span> <span class="n">peak_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">peak_x</span><span class="p">,</span> <span class="n">peak_y</span><span class="p">,</span> <span class="s1">&#39;t: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">peak_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms</span><span class="se">\n</span><span class="s1">rate: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">peak_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="c1"># mark baseline</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">t_baseline</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">))</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_activity</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">)</span>
                    <span class="c1"># mark return to baseline</span>
            <span class="k">if</span> <span class="n">b_normalize_rate</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">psths</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">baseline_activity</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                          <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth_cur</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">psths</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                          <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth_cur</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psths_smooth</span><span class="p">:</span>
            <span class="c1"># get baseline activity</span>
            <span class="k">if</span> <span class="n">t_baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">baseline_activity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">samp_baseline_start</span><span class="p">:</span><span class="n">samp_baseline_end</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">b_markers</span><span class="p">:</span>
                    <span class="c1"># mark peak</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">t_peak_range</span><span class="p">:</span>
                        <span class="n">t_peak_range_idx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_values</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t_peak_range_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">t_peak_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">t_peak_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">peak_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">peak_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="n">t_peak_range_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">peak_x</span> <span class="o">=</span> <span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">peak_i</span><span class="p">]</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_x</span><span class="p">,</span> <span class="n">peak_y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">peak_x</span><span class="p">,</span> <span class="n">peak_y</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">peak_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">peak_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
                    <span class="c1"># mark baseline</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="o">*</span><span class="n">t_baseline</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">))</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">baseline_activity</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">)</span>
                    <span class="c1"># mark return to baseline</span>
                    <span class="n">first_below_bl_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">peak_i</span><span class="p">:])</span> <span class="o">&lt;=</span> <span class="n">baseline_activity</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">peak_i</span>
                    <span class="n">first_below_bl_x</span> <span class="o">=</span> <span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">first_below_bl_i</span><span class="p">]</span>  <span class="c1"># first point below baseline</span>
                    <span class="n">diff_to_prev_y</span> <span class="o">=</span> <span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">first_below_bl_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">first_below_bl_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">diff_to_bl_y</span> <span class="o">=</span> <span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">first_below_bl_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline_activity</span>
                    <span class="n">ratio_diff</span> <span class="o">=</span> <span class="n">diff_to_bl_y</span> <span class="o">/</span> <span class="n">diff_to_prev_y</span>
                    <span class="n">diff_to_prev_x</span> <span class="o">=</span> <span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">first_below_bl_i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">first_below_bl_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">diff_to_bl_x</span> <span class="o">=</span> <span class="n">diff_to_prev_x</span> <span class="o">*</span> <span class="n">ratio_diff</span>
                    <span class="n">bl_crossing</span> <span class="o">=</span> <span class="n">first_below_bl_x</span> <span class="o">-</span> <span class="n">diff_to_bl_x</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bl_crossing</span><span class="p">,</span> <span class="n">baseline_activity</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">bl_crossing</span><span class="p">,</span> <span class="n">baseline_activity</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bl_crossing</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms</span><span class="se">\n</span><span class="s1"> &#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">baseline_activity</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">b_normalize_rate</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">baseline_activity</span><span class="p">,</span> <span class="n">linestyle_smoothed</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth_cur</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">psths_smooth</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">linestyle_smoothed</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span>
                          <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth_cur</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_x</span><span class="p">:</span>
            <span class="n">min_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_x</span><span class="p">:</span>
            <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t_values</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="c1"># plot average psth</span>
    <span class="k">if</span> <span class="n">b_plot_average</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

    <span class="c1"># other settings</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_legend</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="plot_spikes_psth"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_spikes_psth">[docs]</a><span class="k">def</span> <span class="nf">plot_spikes_psth</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">,</span> <span class="n">duration_ms</span><span class="p">,</span> <span class="n">dot_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">recording_offset_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">psth_dt_ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">plot_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">b_smoothed_psth</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot all spiketimes of one or more neurons/trials of one neuron into one subplot, with the</span>
<span class="sd">    peri-stimulus time histogram in a separate subplot.</span>

<span class="sd">    :param spiketimes_ms: list of lists of spike times of the neurons (one sublist per neuron or trial)</span>
<span class="sd">    :type spiketimes_ms: [[float]]</span>
<span class="sd">    :param duration_ms: total duration of recording / simulation and therefore of psth</span>
<span class="sd">    :type duration_ms: int or float</span>
<span class="sd">    :param dot_size: [default=2] size for spike markers in dot raster plot</span>
<span class="sd">    :type dot_size: int or float</span>
<span class="sd">    :param recording_offset_ms: [default=0] plots of recording data will start at this timepoint into the recording [ms]</span>
<span class="sd">    :type recording_offset_ms: int or float</span>
<span class="sd">    :param psth_dt_ms: [default=5] time bin [ms] for the peri-stimulus-time histogram (psth)</span>
<span class="sd">    :type psth_dt_ms: int or float</span>
<span class="sd">    :param plot_duration: [default=None] if not None, this determins the right hand x-axis limit for the plots</span>
<span class="sd">    :type plot_duration: int or float or None</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param b_smoothed_psth: [default=True] also plot smoothed psth as dotted line</span>
<span class="sd">    :type b_smoothed_psth: bool</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axes: list of axis handles</span>
<span class="sd">        - t_values: list of time values of psth bins (left edges) in milliseconds as returned by p_analysis.get_psth()</span>
<span class="sd">        - psth: list of estimated spike rates per time bin as returned by p_analysis.get_psth()</span>
<span class="sd">        - psth_smooth: same as psth, but smoothed using Savitzky-Golay filter (None if b_smoothed_psth==False)</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axes: [matplotlib.axes._subplots.AxesSubplot]</span>
<span class="sd">        - t_values: [float]</span>
<span class="sd">        - psth: [float]</span>
<span class="sd">        - psth_smooth: [float] or None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">,</span> \
        <span class="s2">&quot;spiketimes_ms must be a list of lists of spiketimes (in milliseconds; one sublist per trace)&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spiketimes_ms</span><span class="p">),</span> \
        <span class="s2">&quot;spiketimes_ms must be a list of lists of spiketimes (in milliseconds; one sublist per trace)&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># create figure and set up grid for subplots</span>
    <span class="n">n_gridrows</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>

    <span class="c1"># plot all spikes</span>
    <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;[Trial/Neuron] #&#39;</span><span class="p">)</span>
    <span class="c1"># add right hand axis for population size</span>
    <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spike times&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
    <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;playback&quot;</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="c1"># go through list entries of spiketimes_ms (neurons or trials) and plot all spikes for each</span>
    <span class="n">spiketimes_offset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">)):</span>
        <span class="c1"># subtract offset from time values</span>
        <span class="n">spiketimes_offset</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spiketimes_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">recording_offset_ms</span>
                                  <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">]))])</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spiketimes_offset</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="p">[</span><span class="n">nrn</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_offset</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                     <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
    <span class="c1"># set y-axis limits and sample size for right axis</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;n = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_ms</span><span class="p">)))</span>
    <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># calculate peri-stimulus-time histogram (psth)</span>
    <span class="n">t_values</span><span class="p">,</span> <span class="n">psth</span><span class="p">,</span> <span class="n">psth_smooth</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_psth</span><span class="p">(</span><span class="n">spiketimes_offset</span><span class="p">,</span> <span class="n">duration_ms</span><span class="p">,</span> <span class="n">psth_dt_ms</span><span class="o">=</span><span class="n">psth_dt_ms</span><span class="p">,</span>
                                                      <span class="n">b_smoothed_psth</span><span class="o">=</span><span class="n">b_smoothed_psth</span><span class="p">)</span>

    <span class="c1"># set maximum plot time for axis limits</span>
    <span class="k">if</span> <span class="n">plot_duration</span><span class="p">:</span>
        <span class="n">t_max</span> <span class="o">=</span> <span class="n">plot_duration</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_values</span><span class="p">)</span>

    <span class="c1"># set up subplot for psths</span>
    <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">axis_tmp</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Peri-stimulus-time histogram&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
    <span class="n">axis_tmp</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;average spike rate [Hz]&#39;</span><span class="p">)</span>
    <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
    <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
    <span class="c1"># plot psths</span>
    <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">psth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;psth&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_smoothed_psth</span><span class="p">:</span>
        <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">psth_smooth</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;smoothed psth&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
    <span class="c1"># add right hand axis for bin size text</span>
    <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axis_tmp</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;bin size = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">psth_dt_ms</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span>
    <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># share x axis (time) among all horizontal plots</span>
    <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
    <span class="c1"># disable x tick labels for spike raster plot</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

    <span class="c1"># other settings</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">t_values</span><span class="p">,</span> <span class="n">psth</span><span class="p">,</span> <span class="n">psth_smooth</span></div>


<div class="viewcode-block" id="plot_spikes_psth_comparison"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_spikes_psth_comparison">[docs]</a><span class="k">def</span> <span class="nf">plot_spikes_psth_comparison</span><span class="p">(</span><span class="n">spiketimes_mod_ms</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">idx_pop_oi</span><span class="p">,</span> <span class="n">spiketimes_rec_ms</span><span class="p">,</span> <span class="n">t_values_mod</span><span class="p">,</span> <span class="n">t_values_rec</span><span class="p">,</span>
                                <span class="n">psths_mod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psths_rec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psths_mod_smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psths_rec_smooth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">dot_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">recording_offset_ms</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot spiketimes of all trials of a recorded neuron (spiketimes_rec_ms) into one subplot and spiketimes of all</span>
<span class="sd">    model neurons from one population (idx_pop_oi) into a second subplot. Plot peri-stimulus time histograms for both</span>
<span class="sd">    in a separate subplot. One figure per spikemon (i.e. model run)</span>

<span class="sd">    :param spiketimes_mod_ms: list of lists of spike times of the model neurons (one sublist per neuron or trial)</span>
<span class="sd">    :type spiketimes_mod_ms: [[float]]</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param idx_pop_oi: index of the model neuron population whose neurons are to be plotted</span>
<span class="sd">    :type idx_pop_oi: int</span>
<span class="sd">    :param spiketimes_rec_ms: list of lists of spike times of the recorded neurons (one sublist per neuron or trial)</span>
<span class="sd">    :type spiketimes_rec_ms: [[float]]</span>
<span class="sd">    :param t_values_mod: (list of) list(s) of time values of psth bins (left edges) in milliseconds for model neurons</span>
<span class="sd">    :type t_values_mod: [float] or [[float]]</span>
<span class="sd">    :param t_values_rec: (list of) list(s) of time values of psth bins (left edges) in milliseconds for recorded neurons</span>
<span class="sd">    :type t_values_rec: [float] or [[float]]</span>
<span class="sd">    :param psths_mod: [default=None] (list of) psth(s) for model neurons, as returned by p_analysis.get_psth(). pass</span>
<span class="sd">        either psths_mod, psths_mod_smoothed or both.</span>
<span class="sd">    :type psths_mod: [float] or [[float]] or None</span>
<span class="sd">    :param psths_rec: [default=None] (list of) psth(s) for recorded neurons, as returned by p_analysis.get_psth(). pass</span>
<span class="sd">        either psths_rec, psths_rec_smoothed or both.</span>
<span class="sd">    :type psths_rec: [float] or [[float]] or None</span>
<span class="sd">    :param psths_mod_smooth: [default=None] smoothed psth(s) for model neurons as returned by p_analysis.get_psth()</span>
<span class="sd">    :type psths_mod_smooth: [float] or [[float]] or None</span>
<span class="sd">    :param psths_rec_smooth: [default=None] smoothed psth(s) for recorded neurons as returned by p_analysis.get_psth()</span>
<span class="sd">    :type psths_rec_smooth: [float] or [[float]] or None</span>
<span class="sd">    :param dot_size: [default=2] size for spike markers in dot raster plot</span>
<span class="sd">    :type dot_size: int or float</span>
<span class="sd">    :param recording_offset_ms: [default=0] plots of recording data will start at this timepoint into the recording [ms]</span>
<span class="sd">    :type recording_offset_ms: int or float</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle(s)</span>
<span class="sd">        - axes: list of list of axis handles</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: [matplotlib.figure.Figure]</span>
<span class="sd">        - axes: [[matplotlib.axes._subplots.AxesSubplot]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if info, t_values, psths and/or psths_smooth are a single object/list, convert them to a list of a objects/lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t_values_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">t_values_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_values_mod</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t_values_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">t_values_rec</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_values_rec</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">psths_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">psths_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">psths_mod</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">psths_rec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">psths_rec</span> <span class="o">=</span> <span class="p">[</span><span class="n">psths_rec</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">psths_mod_smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_mod_smooth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">psths_mod_smooth</span> <span class="o">=</span> <span class="p">[</span><span class="n">psths_mod_smooth</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">psths_rec_smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_rec_smooth</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">psths_rec_smooth</span> <span class="o">=</span> <span class="p">[</span><span class="n">psths_rec_smooth</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spiketimes_mod_ms</span><span class="p">),</span> \
        <span class="s2">&quot;spiketimes_mod_ms must be a list of lists&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">idx_pop_oi</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;idx_pop_oi must be an integer&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">t_values_mod</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">t_values_rec</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">,</span> <span class="s2">&quot;t_values_mod/rec must be (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_mod</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">psths_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psths_mod must be a (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_rec</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">psths_rec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psths_rec must be a (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_mod_smooth</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">psths_mod_smooth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psths_mod_smooth must be a (list of) list(s)&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">psths_rec_smooth</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="n">psths_rec_smooth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;psths_mod_smooth must be a (list of) list(s)&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_values_mod</span><span class="p">)</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">n_figs</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: More than 20 figures are about to be created...&quot;</span><span class="p">)</span>

    <span class="c1"># loop through list of spike monitors</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_figs</span><span class="p">):</span>
        <span class="c1"># create figure and set up grid for subplots</span>
        <span class="n">n_populations</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;n_populations&#39;</span><span class="p">]</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">fig_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_tmp</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">color_map_light</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS_LIGHT</span><span class="p">)</span>
        <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_populations</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">)</span>

        <span class="c1"># plot all spikes for population of model neurons and recordings of real neuron</span>
        <span class="k">for</span> <span class="n">subplt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="c1"># set up subplot</span>
            <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">subplt</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">idx_pop_oi</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; #&#39;</span><span class="p">)</span>
            <span class="c1"># add right hand axis for population size</span>
            <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">subplt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spike times of model neurons&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spike times of recorded neurons&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">subplt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                           <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;playback&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                                           <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subplt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># go through model neurons and plot all spikes for each neuron</span>
                <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_mod_ms</span><span class="p">)):</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">spiketimes_mod_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="p">[</span><span class="n">nrn</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_mod_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                                           <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">idx_pop_oi</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
                <span class="c1"># set y-axis limits and sample size for right axis</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_mod_ms</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;n = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_mod_ms</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                      <span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">][</span><span class="n">idx_pop_oi</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># go through list entries of spiketimes_rec_ms (neurons or trials) and plot all spikes for each</span>
                <span class="n">spike_times_rec_offset</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_rec_ms</span><span class="p">)):</span>
                    <span class="c1"># subtract offset from time values</span>
                    <span class="n">spike_times_rec_offset</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spiketimes_rec_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
                                                   <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_rec_ms</span><span class="p">[</span><span class="n">nrn</span><span class="p">]))])</span>
                    <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">spike_times_rec_offset</span><span class="p">[</span><span class="n">nrn</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">recording_offset_ms</span>
                                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_times_rec_offset</span><span class="p">[</span><span class="n">nrn</span><span class="p">]))],</span>
                                           <span class="p">[</span><span class="n">nrn</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times_rec_offset</span><span class="p">[</span><span class="n">nrn</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                                           <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">dot_size</span><span class="p">)</span>
                <span class="c1"># set y-axis limits and sample size for right axis</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">subplt</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_rec_ms</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">axis_right</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;n = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spiketimes_rec_ms</span><span class="p">)))</span>

            <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># offset recording t_values for plot</span>
        <span class="n">t_values_rec_offset_cur</span> <span class="o">=</span> <span class="p">[</span><span class="n">t_values_rec</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">recording_offset_ms</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_values_rec</span><span class="p">[</span><span class="n">mon</span><span class="p">]))]</span>

        <span class="c1"># set up subplot for psths</span>
        <span class="n">axis_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="n">n_gridcols</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">axis_tmp</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Peri-stimulus-time histogram&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">axis_tmp</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;average spike rate [Hz]&#39;</span><span class="p">)</span>
        <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
        <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis_tmp</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
        <span class="c1"># plot psths</span>
        <span class="k">if</span> <span class="n">psths_mod</span><span class="p">:</span>
            <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values_mod</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">psths_mod</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">idx_pop_oi</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model psth&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psths_rec</span><span class="p">:</span>
            <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values_rec_offset_cur</span><span class="p">,</span> <span class="n">psths_rec</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;recorded psth&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psths_mod_smooth</span><span class="p">:</span>
            <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values_mod</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="n">psths_mod_smooth</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_light</span><span class="p">[</span><span class="n">idx_pop_oi</span><span class="p">],</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;smoothed model psth&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">psths_rec_smooth</span><span class="p">:</span>
            <span class="n">axis_tmp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values_rec_offset_cur</span><span class="p">,</span> <span class="n">psths_rec_smooth</span><span class="p">[</span><span class="n">mon</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                          <span class="n">label</span><span class="o">=</span><span class="s1">&#39;smoothed recorded psth&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis_tmp</span><span class="p">)</span>
        <span class="c1"># add right hand axis for bin size text</span>
        <span class="n">axis_right</span> <span class="o">=</span> <span class="n">axis_tmp</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">axis_right</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># share x axis (time) among all horizontal plots</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
        <span class="c1"># disable x tick labels for spike raster plots and autoscale all axes</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># other settings</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;sim_time&#39;</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_fi_curve"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_fi_curve">[docs]</a><span class="k">def</span> <span class="nf">plot_fi_curve</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">spikemons</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot frequency response curve for varying input current (F-I curve). Needs results of a simulation with range</span>
<span class="sd">    of amplitudes for input step current, i.e. multiple simulation runs with varying input amplitude.</span>

<span class="sd">    :param statemons: (list of) brian2 StateMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type statemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param spikemons: (list of) brian2 SpikeMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type spikemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param config: dictionary as loaded from .json configuration file</span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - axis: axis handle</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - axis: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if statemons, spikemons and neuron_idx contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">statemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">spikemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">statemonitor</span><span class="o">.</span><span class="n">StateMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">),</span> \
        <span class="s2">&quot;statemons must be (list of) b2.StateMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">spikemonitor</span><span class="o">.</span><span class="n">SpikeMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spikemons</span><span class="p">),</span> \
        <span class="s2">&quot;spikemons must be (list of) b2.SpikeMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;statemons, spikemons and info must all have the same number of elements&quot;</span>

    <span class="c1"># check if input current was recorded in statemons</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Ie&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;p_plot.plot_fi_curve(): &#39;Ie&#39; is not an attribute of statemons[0], i.e. no input current was recorded&quot;</span> <span class="o">+</span>
              <span class="s2">&quot; =&gt; fI curve is not being plotted&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># create figure and set up grid for subplots</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">h_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_neurons</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span>
    <span class="n">n_runs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">CMAP_NAME_CONTINUOUS</span><span class="p">)</span>

    <span class="c1"># loop through runs</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_runs</span><span class="p">):</span>
        <span class="n">freq_cur_run</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_cur_nrn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># loop through populations and calculate f-I curve</span>
        <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>
            <span class="n">spikes_cur_nrn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">spikemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="n">nrn</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>
            <span class="n">onset_stim_ms</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_current&#39;</span><span class="p">][</span><span class="s1">&#39;t_start&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">offset_stim_ms</span> <span class="o">=</span> <span class="n">onset_stim_ms</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_current&#39;</span><span class="p">][</span><span class="s1">&#39;duration&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">stim_duration</span> <span class="o">=</span> <span class="n">offset_stim_ms</span> <span class="o">-</span> <span class="n">onset_stim_ms</span>
            <span class="n">b_spikes_during_stim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">spikes_cur_nrn</span> <span class="o">&gt;=</span> <span class="n">onset_stim_ms</span><span class="p">,</span> <span class="n">spikes_cur_nrn</span> <span class="o">&lt;</span> <span class="n">offset_stim_ms</span><span class="p">)</span>
            <span class="n">n_spikes_cur_nrn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b_spikes_during_stim</span><span class="p">)</span>
            <span class="n">freq_cur_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_spikes_cur_nrn</span> <span class="o">/</span> <span class="n">stim_duration</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">i_current_onset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="n">onset_stim_ms</span> <span class="o">*</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_cur_nrn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Ie</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_current_onset</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">nA</span><span class="p">)</span>

        <span class="c1"># plot voltage traces</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">]:</span>
            <span class="n">h_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">current_cur_nrn</span><span class="p">,</span> <span class="n">freq_cur_run</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">mon</span> <span class="o">/</span> <span class="n">n_runs</span><span class="p">),</span>
                                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;free_parameter_values&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">current_cur_nrn</span><span class="p">,</span> <span class="n">freq_cur_run</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">mon</span> <span class="o">/</span> <span class="n">n_runs</span><span class="p">),</span>
                                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># set axis properties</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Input current [nA]&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average firing frequency [Hz]&#39;</span><span class="p">)</span>

    <span class="c1"># add legend</span>
    <span class="k">if</span> <span class="n">n_runs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">axis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;free_parameter_name&#39;</span><span class="p">],</span> <span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span></div>


<div class="viewcode-block" id="plot_psp_psc"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_psp_psc">[docs]</a><span class="k">def</span> <span class="nf">plot_psp_psc</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">b_share_y_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_const_span_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">b_black_background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_maxmin_marker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">b_derivative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">i_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot voltage traces (post-synaptic potential) and synaptic currents (post-synaptic current) for all neurons.</span>
<span class="sd">    Works for simulations in which each neuron recieves a single spike at t=0 from a separate spikegenerator.</span>
<span class="sd">    on_pre equations must be excitatory first, inhibitory second (see usage of on_pre_idx_gen below).</span>

<span class="sd">    :param statemons: (list of) brian2 StateMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type statemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param config: dictionary as loaded from .json configuration file</span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param b_share_y_axis: [default=True] if true, all voltage trace subplots share the same y-axis limits</span>
<span class="sd">    :type b_share_y_axis: bool</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param t_const_span_marker: [default=None] timespan (list of x_min and x_max) at which to plot a shaded rectangle</span>
<span class="sd">    :type t_const_span_marker: [int, int] or [float, float] or None</span>
<span class="sd">    :param b_black_background: [default=False] plot on black background</span>
<span class="sd">    :type b_black_background: bool</span>
<span class="sd">    :param b_maxmin_marker: [default=False] mark maximum and minimum of each trace (if above/below initial voltage)</span>
<span class="sd">    :type b_maxmin_marker: bool</span>
<span class="sd">    :param b_derivative: plot derivative of each trace, rescaled and shifted to trace plot</span>
<span class="sd">    :type b_derivative: bool</span>
<span class="sd">    :param i_colors: [default=None] list of indices to colors of the colormap (i.e. order of colors) of length n_colors</span>
<span class="sd">    :type i_colors: list or None</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle(s)</span>
<span class="sd">        - axes: axis handles, one sublist per figure</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: [matplotlib.figure.Figure]</span>
<span class="sd">        - axes: [[matplotlib.axes._subplots.AxesSubplot]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if statemons and spikemons contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">statemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">b2</span><span class="o">.</span><span class="n">monitors</span><span class="o">.</span><span class="n">statemonitor</span><span class="o">.</span><span class="n">StateMonitor</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">SimpleNamespace</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">statemons</span><span class="p">),</span> \
        <span class="s2">&quot;statemons must be a list of b2.StateMonitor or (if loaded through p_io.load_monitors) SimpleNamespace objects&quot;</span>

    <span class="c1"># set figure style</span>
    <span class="k">if</span> <span class="n">b_black_background</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn-dark&#39;</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_figs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="c1"># loop through list of state monitors</span>
    <span class="k">for</span> <span class="n">mon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_figs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;. plotting PSPs and PSCs for all neurons&quot;</span><span class="p">)</span>

        <span class="c1"># create figure and set up grid for subplots</span>
        <span class="n">n_neurons</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_gridrows</span> <span class="o">=</span> <span class="n">n_neurons</span>
        <span class="n">fig_tmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_tmp</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
        <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">i_colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_colors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">))</span>
        <span class="n">color_map_light</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS_LIGHT</span><span class="p">,</span> <span class="n">i_colors</span><span class="o">=</span><span class="n">i_colors</span><span class="p">)</span>
        <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">,</span> <span class="n">i_colors</span><span class="o">=</span><span class="n">i_colors</span><span class="p">)</span>

        <span class="c1"># loop through all neurons in current statemonitor and plot the voltage trace and synaptic current</span>
        <span class="n">max_voltage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">min_voltage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">max_current</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">min_current</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">nrn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">):</span>
            <span class="c1"># set up subplot for PSP plot</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">nrn</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\mathrm</span><span class="si">{V_m}</span><span class="s1">$ [mV]&#39;</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="c1"># plot voltage traces</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">][</span><span class="s1">&#39;on_pre_idx_gen&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_trace</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Ise</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">pA</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;EPSP &#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">][</span><span class="s1">&#39;on_pre_idx_gen&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_trace</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Isi</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">pA</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;IPSP &#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_dark</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span>
                      <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># get max/min for y-axis</span>
            <span class="n">max_voltage_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
            <span class="n">min_voltage_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_voltage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_voltage_cur</span> <span class="o">&gt;</span> <span class="n">max_voltage</span><span class="p">:</span>
                <span class="n">max_voltage</span> <span class="o">=</span> <span class="n">max_voltage_cur</span>
            <span class="k">if</span> <span class="n">min_voltage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">min_voltage_cur</span> <span class="o">&lt;</span> <span class="n">min_voltage</span><span class="p">:</span>
                <span class="n">min_voltage</span> <span class="o">=</span> <span class="n">min_voltage_cur</span>
            <span class="c1"># plot marker at maximum / minimum voltage</span>
            <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                <span class="n">initial_voltage</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                <span class="k">if</span> <span class="n">max_voltage_cur</span> <span class="o">&gt;</span> <span class="n">initial_voltage</span><span class="p">:</span>
                    <span class="n">i_max_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                    <span class="n">t_max_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_max_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">amp_peak</span> <span class="o">=</span> <span class="n">max_voltage_cur</span> <span class="o">-</span> <span class="n">initial_voltage</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="n">max_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_v</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;time-to-peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms, amplitude: &#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;mV&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_max_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_25_percent</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;25</span><span class="si">% r</span><span class="s1">ise time: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                              <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">min_voltage_cur</span> <span class="o">&lt;</span> <span class="n">initial_voltage</span><span class="p">:</span>
                    <span class="n">i_min_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                    <span class="n">t_min_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_min_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">amp_peak</span> <span class="o">=</span> <span class="n">min_voltage_cur</span> <span class="o">-</span> <span class="n">initial_voltage</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="n">min_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_v</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_voltage_cur</span><span class="p">,</span> <span class="s1">&#39;time-to-peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms, amplitude: &#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;mV&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_min_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="n">i_25_percent</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;25</span><span class="si">% r</span><span class="s1">ise time: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                              <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="c1"># plot derivative of trace</span>
            <span class="k">if</span> <span class="n">b_derivative</span><span class="p">:</span>
                <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">mV</span><span class="p">)</span>
                <span class="n">min_g</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="n">max_g</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="n">scaling_factor_g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_g</span> <span class="o">-</span> <span class="n">min_g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_voltage_cur</span> <span class="o">-</span> <span class="n">min_voltage_cur</span><span class="p">)</span>
                <span class="n">gradient_rescaled</span> <span class="o">=</span> <span class="n">gradient</span> <span class="o">*</span> <span class="n">scaling_factor_g</span>
                <span class="n">gradient_shifted</span> <span class="o">=</span> <span class="n">gradient_rescaled</span> <span class="o">-</span> <span class="n">min_g</span> <span class="o">*</span> <span class="n">scaling_factor_g</span> <span class="o">+</span> <span class="n">min_voltage_cur</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">gradient_shifted</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_g</span><span class="p">):</span>
                        <span class="n">t_max_g</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gradient</span><span class="p">)]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;  ttp: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                                  <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_g</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_g</span><span class="p">):</span>
                        <span class="n">t_min_g</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">gradient</span><span class="p">)]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;  peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                                  <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_voltage_cur</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">),</span>
                          <span class="n">max_voltage_cur</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">))</span>

            <span class="c1"># set up subplot for PSC plot ###############################################################</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">nrn</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\mathrm</span><span class="si">{I_s}</span><span class="s1">$ [pA]&#39;</span><span class="p">)</span>
            <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that timepoint</span>
            <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t_const_span_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_const_span_marker</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">C_COLORS_GREY</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
            <span class="c1"># plot synaptic currents</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">][</span><span class="s1">&#39;on_pre_idx_gen&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">current_trace</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Ise</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">pA</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;EPSC &#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;generator&#39;</span><span class="p">][</span><span class="s1">&#39;on_pre_idx_gen&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_trace</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">Isi</span><span class="p">[</span><span class="n">nrn</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">pA</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;IPSC &#39;</span> <span class="o">+</span> <span class="n">info</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="s1">&#39;population_ids&#39;</span><span class="p">][</span><span class="n">nrn</span><span class="p">]</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">current_trace</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color_map_light</span><span class="p">[</span><span class="n">nrn</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># get max/min for y-axis</span>
            <span class="n">max_current_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_trace</span><span class="p">)</span>
            <span class="n">min_current_cur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">current_trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">max_current</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_current_cur</span> <span class="o">&gt;</span> <span class="n">max_current</span><span class="p">:</span>
                <span class="n">max_current</span> <span class="o">=</span> <span class="n">max_current_cur</span>
            <span class="k">if</span> <span class="n">min_current</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">min_current_cur</span> <span class="o">&lt;</span> <span class="n">min_current</span><span class="p">:</span>
                <span class="n">min_current</span> <span class="o">=</span> <span class="n">min_current_cur</span>
            <span class="c1"># plot marker at maximum / minimum current</span>
            <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                <span class="n">initial_current</span> <span class="o">=</span> <span class="n">current_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">max_current_cur</span> <span class="o">&gt;</span> <span class="n">initial_current</span><span class="p">:</span>
                    <span class="n">i_max_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">current_trace</span><span class="p">)</span>
                    <span class="n">t_max_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_max_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">amp_peak</span> <span class="o">=</span> <span class="n">max_current_cur</span> <span class="o">-</span> <span class="n">initial_current</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="n">max_current_cur</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_v</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_current_cur</span><span class="p">,</span> <span class="s1">&#39;time-to-peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms, amplitude: &#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;pA&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">current_trace</span><span class="p">,</span> <span class="n">i_max_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">current_trace</span><span class="p">[</span><span class="n">i_25_percent</span><span class="p">]</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;25</span><span class="si">% r</span><span class="s1">ise time: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                              <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">min_current_cur</span> <span class="o">&lt;</span> <span class="n">initial_current</span><span class="p">:</span>
                    <span class="n">i_min_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">current_trace</span><span class="p">)</span>
                    <span class="n">t_min_v</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">i_min_v</span><span class="p">]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                    <span class="n">amp_peak</span> <span class="o">=</span> <span class="n">min_current_cur</span> <span class="o">-</span> <span class="n">initial_current</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="n">min_current_cur</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_v</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_current_cur</span><span class="p">,</span> <span class="s1">&#39;time-to-peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms, amplitude: &#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;pA&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="c1"># get and mark 25% rise time</span>
                    <span class="n">t_rise</span><span class="p">,</span> <span class="n">i_25_percent</span> <span class="o">=</span> <span class="n">p_analysis</span><span class="o">.</span><span class="n">get_rise_time</span><span class="p">(</span><span class="n">current_trace</span><span class="p">,</span> <span class="n">i_min_v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                                                                    <span class="n">sampling_frequency_khz</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span>
                                                                    <span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">kHz</span><span class="p">)</span>
                    <span class="n">v_25_percent</span> <span class="o">=</span> <span class="n">current_trace</span><span class="p">[</span><span class="n">i_25_percent</span><span class="p">]</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                    <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_rise</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">v_25_percent</span><span class="p">,</span> <span class="s1">&#39;25</span><span class="si">% r</span><span class="s1">ise time: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_rise</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                              <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="c1"># plot derivative of current</span>
            <span class="k">if</span> <span class="n">b_derivative</span><span class="p">:</span>
                <span class="n">gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">current_trace</span><span class="p">)</span>
                <span class="n">min_g</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="n">max_g</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient</span><span class="p">)</span>
                <span class="n">scaling_factor_g</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_g</span> <span class="o">-</span> <span class="n">min_g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_current_cur</span> <span class="o">-</span> <span class="n">min_current_cur</span><span class="p">)</span>
                <span class="n">gradient_rescaled</span> <span class="o">=</span> <span class="n">gradient</span> <span class="o">*</span> <span class="n">scaling_factor_g</span>
                <span class="n">gradient_shifted</span> <span class="o">=</span> <span class="n">gradient_rescaled</span> <span class="o">-</span> <span class="n">min_g</span> <span class="o">*</span> <span class="n">scaling_factor_g</span> <span class="o">+</span> <span class="n">min_current_cur</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">gradient_shifted</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gradient&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">b_maxmin_marker</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_g</span><span class="p">):</span>
                        <span class="n">t_max_g</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">gradient</span><span class="p">)]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;  peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_max_g</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                                  <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_g</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_g</span><span class="p">):</span>
                        <span class="n">t_min_g</span> <span class="o">=</span> <span class="n">statemons</span><span class="p">[</span><span class="n">mon</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">gradient</span><span class="p">)]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;xk&#39;</span><span class="p">)</span>
                        <span class="n">axis</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">gradient_shifted</span><span class="p">),</span> <span class="s1">&#39;  peak: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_min_g</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
                                  <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">min_current_cur</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">),</span>
                          <span class="n">max_current_cur</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amp_peak</span><span class="p">))</span>

        <span class="c1"># share y axis among voltage trace plots and x axis (time) among all horizontal plots</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">b_share_y_axis</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="c1"># disable x tick labels for plots except for last plot and autoscale all axes</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">)]</span>
        <span class="c1"># [axes[mon][n].autoscale() for n in range(len(axes[mon]))]</span>

        <span class="c1"># set y-limits</span>
        <span class="k">if</span> <span class="n">b_share_y_axis</span><span class="p">:</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">min_voltage</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">max_voltage</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">min_current</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">max_current</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="c1"># set y tick labels of spike plot to population ids, and other settings</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
        <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">))</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">mon</span><span class="p">]))]</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="plot_input_current"><a class="viewcode-back" href="../p_plot.html#p_plot.plot_input_current">[docs]</a><span class="k">def</span> <span class="nf">plot_input_current</span><span class="p">(</span><span class="n">statemons</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">t_const_event_marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot input current as generated by p_input_setup currents from a .json config file.</span>

<span class="sd">    :param statemons: (list of) brian2 StateMonitor - like(!) SimpleNamespaces from file or dicts from b2...get_states()</span>
<span class="sd">    :type statemons: SimpleNamespace or dict or list</span>
<span class="sd">    :param info: dictionary or list of dicts containing additional information about simulation (one dict per run)</span>
<span class="sd">    :type info: dict or list</span>
<span class="sd">    :param config: dictionary as loaded from .json configuration file</span>
<span class="sd">    :type config: dict</span>
<span class="sd">    :param t_const_event_marker: [default=None] timepoint at which to plot a vertical line as marker</span>
<span class="sd">    :type t_const_event_marker: int or float or None</span>
<span class="sd">    :param marker_linestyle: linestyle for event marker (default: &#39;--&#39; = dashed line)</span>
<span class="sd">    :type marker_linestyle: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if statemons and info contain a single object, convert them to lists</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">statemons</span> <span class="o">=</span> <span class="p">[</span><span class="n">statemons</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>

    <span class="c1"># check inputs</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;info must be a dictionary or list of dictionaries&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">statemons</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> \
        <span class="s2">&quot;statemons and info must have the same number of elements&quot;</span>

    <span class="c1"># create figure and set up grid for subplots (if b_average_aggregate, only create one figure</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>
    <span class="n">n_pops</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;population_sizes&#39;</span><span class="p">])</span>
    <span class="n">n_gridcols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">n_pops</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">n_gridrows</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">matplotlib</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">)</span>
    <span class="n">color_map_dark</span> <span class="o">=</span> <span class="n">get_color_list</span><span class="p">(</span><span class="n">n_pops</span><span class="p">,</span> <span class="n">color_map_in</span><span class="o">=</span><span class="n">C_COLORS</span><span class="p">,</span> <span class="n">i_colors</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

    <span class="c1"># loop through populations</span>
    <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pops</span><span class="p">):</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="n">n_gridrows</span><span class="p">,</span> <span class="n">n_gridcols</span><span class="p">),</span> <span class="p">(</span><span class="n">pop</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">pop</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)),</span>
                                     <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># if time for an event marker or span was passed, plot a vertical line or shaded rectangle at that time</span>
        <span class="k">if</span> <span class="n">t_const_event_marker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">t_const_event_marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">marker_linestyle</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="c1"># plot input current</span>
        <span class="n">color_cur</span> <span class="o">=</span> <span class="n">color_map_dark</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">statemons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">ms</span> <span class="o">-</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;misc&#39;</span><span class="p">][</span><span class="s1">&#39;playback_start&#39;</span><span class="p">],</span> <span class="n">statemons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ie</span><span class="p">[</span><span class="n">pop</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">b2</span><span class="o">.</span><span class="n">pA</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="n">color_cur</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># other settings</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;t [ms]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ie [pA]&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">pop</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

    <span class="c1"># share x axis (time) among all  plots</span>
    <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_pops</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span></div>


<div class="viewcode-block" id="dot_plot"><a class="viewcode-back" href="../p_plot.html#p_plot.dot_plot">[docs]</a><span class="k">def</span> <span class="nf">dot_plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">group_names</span><span class="p">,</span> <span class="n">x_label</span><span class="p">,</span> <span class="n">y_label</span><span class="p">,</span> <span class="n">value_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">b_paired</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">b_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">b_jitter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jitter_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jitter_offset</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dot plot of one or more groups (x-axis).</span>

<span class="sd">    :param values: list of lists of values to be plotted. one sublist per group. first group is at x=0, second at x=1...</span>
<span class="sd">    :type values: list</span>
<span class="sd">    :param group_names: list of group names (strings) that are used as x-tick labels. in order of sublists in values</span>
<span class="sd">    :type group_names: list</span>
<span class="sd">    :param x_label: x-axis label</span>
<span class="sd">    :type x_label: str</span>
<span class="sd">    :param y_label: y-axis label</span>
<span class="sd">    :type y_label: str</span>
<span class="sd">    :param value_colors: (list of) list(s) of color values, one color for each value. either one sublist per group, or</span>
<span class="sd">        one list that gets duplicated for each group. in that case it must be at least as long as the largest group</span>
<span class="sd">    :type value_colors: list or None</span>
<span class="sd">    :param marker_size: (list of) sizes of dots, one int per value OR one int that will be repeated for all points</span>
<span class="sd">    :type marker_size: list or int</span>
<span class="sd">    :param b_paired: if True, values in sublists of values are considered paired, i.e. values[0][0] &lt;-&gt; values[1][0] ...</span>
<span class="sd">        lines are drawn that connect paried values between groups</span>
<span class="sd">    :type b_paired: bool</span>
<span class="sd">    :param b_mean: if True, the group means are plotted as horizontal lines</span>
<span class="sd">    :type b_mean: bool</span>
<span class="sd">    :param b_jitter: if True, nearby dots are jittered along the x-axis to avoid overlap</span>
<span class="sd">    :type b_jitter: bool</span>
<span class="sd">    :param jitter_thresh: threshold distance between two consecutive (sorted) y-values, below which dots are to be</span>
<span class="sd">        jittered. If None, the threshold will be automatically calculated depending on the data.</span>
<span class="sd">    :type jitter_thresh: float</span>
<span class="sd">    :param jitter_offset: amount by which each dot is offset on the x-axis</span>
<span class="sd">    :type jitter_offset: float</span>
<span class="sd">    :param h_ax: handle to the axis in which the psths are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - ax: axis handles, one sublist per figure</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set up figure</span>
    <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_groups</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">h_ax</span>

    <span class="c1"># if value_colors is a single list of color values, duplicate this list for each group</span>
    <span class="k">if</span> <span class="n">value_colors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">value_colors</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_groups</span>

    <span class="c1"># if marker_size contains a single integer, repeat this for all values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">marker_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">marker_size</span> <span class="o">=</span> <span class="p">[[</span><span class="n">marker_size</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>

    <span class="c1"># determine jitter threshold</span>
    <span class="k">if</span> <span class="n">b_jitter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">jitter_thresh</span><span class="p">:</span>
        <span class="n">jitter_thresh</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">25</span>

    <span class="c1"># loop through groups</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
        <span class="n">n_values_cur</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
        <span class="c1"># jitter nearby dots along the x-axis</span>
        <span class="k">if</span> <span class="n">b_jitter</span><span class="p">:</span>
            <span class="n">x_values</span> <span class="o">=</span> <span class="n">jitter_dots</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">jitter_thresh</span><span class="o">=</span><span class="n">jitter_thresh</span><span class="p">,</span> <span class="n">jitter_offset</span><span class="o">=</span><span class="n">jitter_offset</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_values_cur</span>
        <span class="k">if</span> <span class="n">b_paired</span> <span class="ow">and</span> <span class="n">g</span> <span class="o">&lt;</span> <span class="n">n_groups</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_values_cur</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">x_values</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">x_values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">v</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">v</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">],</span>
                         <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_mean</span><span class="p">:</span>
            <span class="n">cur_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">g</span> <span class="o">-</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">g</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">),</span> <span class="p">(</span><span class="n">cur_mean</span><span class="p">,</span> <span class="n">cur_mean</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_colors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_values_cur</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">v</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">value_colors</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">v</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="n">marker_size</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="s1">&#39;.k&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">marker_size</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>

    <span class="c1"># set axis labels, limits, etc</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_groups</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">group_names</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-.</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_groups</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="histogram_plot"><a class="viewcode-back" href="../p_plot.html#p_plot.histogram_plot">[docs]</a><span class="k">def</span> <span class="nf">histogram_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">group_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">h_ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a histogram of one or more groups of values (data).</span>

<span class="sd">    :param data: list of list(s) of values, one sublist per group</span>
<span class="sd">    :type data: list</span>
<span class="sd">    :param group_names: list of strings of group names</span>
<span class="sd">    :type group_names: list</span>
<span class="sd">    :param group_colors: list of strings of group names</span>
<span class="sd">    :type group_colors: list</span>
<span class="sd">    :param x_label: x-axis label</span>
<span class="sd">    :type x_label: str</span>
<span class="sd">    :param y_label: y-axis label</span>
<span class="sd">    :type y_label: str</span>
<span class="sd">    :param binsize: size of the histogram bins in the unit of the data</span>
<span class="sd">    :type binsize: int or float</span>
<span class="sd">    :param h_ax: handle to the axis in which the psths are to be plotted. if None (default) create new figure. if a</span>
<span class="sd">        handle is passed, this function does not have return values.</span>
<span class="sd">    :type h_ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :return:</span>
<span class="sd">        - fig: figure handle</span>
<span class="sd">        - ax: axis handles, one sublist per figure</span>
<span class="sd">    :rtype:</span>
<span class="sd">        - fig: matplotlib.figure.Figure</span>
<span class="sd">        - ax: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set up figure</span>
    <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">h_ax</span>

    <span class="c1"># if value_colors is a single list of color values, duplicate this list for each group</span>
    <span class="k">if</span> <span class="n">group_colors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">group_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_colors</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_groups</span>

    <span class="c1"># plot histograms</span>
    <span class="n">bins_n</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
    <span class="n">min_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
    <span class="n">bin_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">min_data</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span> <span class="o">*</span> <span class="n">binsize</span>
    <span class="n">bin_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">max_data</span> <span class="o">/</span> <span class="n">binsize</span><span class="p">)</span> <span class="o">*</span> <span class="n">binsize</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_groups</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group_colors</span><span class="p">:</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bin_min</span><span class="p">,</span> <span class="n">bin_max</span> <span class="o">+</span> <span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="n">group_names</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">group_colors</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">g</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">bin_min</span><span class="p">,</span> <span class="n">bin_max</span> <span class="o">+</span> <span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="n">group_names</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
        <span class="n">bins_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">max_bin_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="k">for</span> <span class="n">bins</span> <span class="ow">in</span> <span class="n">bins_n</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">bin_min</span><span class="p">,</span> <span class="n">bin_max</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_bin_height</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="jitter_dots"><a class="viewcode-back" href="../p_plot.html#p_plot.jitter_dots">[docs]</a><span class="k">def</span> <span class="nf">jitter_dots</span><span class="p">(</span><span class="n">y_values</span><span class="p">,</span> <span class="n">x_value</span><span class="p">,</span> <span class="n">jitter_thresh</span><span class="p">,</span> <span class="n">jitter_offset</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Jitter nearby dots (e.g. for a dot plot) along the x-axis to avoid overlap</span>

<span class="sd">    :param y_values: list of values that determine closeness (e.g. y-axis values)</span>
<span class="sd">    :type y_values: list</span>
<span class="sd">    :param x_value: original x-axis value, around which dots will be jittered</span>
<span class="sd">    :type x_value: int or float</span>
<span class="sd">    :param jitter_thresh: threshold distance between two consecutive (sorted) y-values, below which dots are to be</span>
<span class="sd">        jittered.</span>
<span class="sd">    :type jitter_thresh: float</span>
<span class="sd">    :param jitter_offset: amount by which each dot is offset on the x-axis</span>
<span class="sd">    :type jitter_offset: float</span>
<span class="sd">    :return: x_values: list of one x-value for each y-value. either the original value, or one slightly offset</span>
<span class="sd">    :rtype: x_values: list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># sort y-axis values</span>
    <span class="n">sorted_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y_values</span><span class="p">)</span>
    <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">y_values</span><span class="p">)</span>

    <span class="c1"># initialize array for x-axis offsets for each point (all start at 0)</span>
    <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">))</span>
    <span class="c1"># initialize variable to keep track of which offset to use next</span>
    <span class="n">next_offset</span> <span class="o">=</span> <span class="n">jitter_offset</span>
    <span class="c1"># the sign of the offset alternates for consecutive close y-values</span>
    <span class="n">sign_of_next_offset</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># this keeps track of the direction of the first of each sets of offset, because initial offsets sometimes alternate</span>
    <span class="n">sign_of_initial_offset</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># this keeps track of the index of the last y-value without offset</span>
    <span class="n">i_last_zero_offset_dot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># go through sorted y-values</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_values</span><span class="p">)):</span>
        <span class="c1"># calculate distance to last point without offset</span>
        <span class="n">dist_to_prev</span> <span class="o">=</span> <span class="n">sorted_values</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">sorted_values</span><span class="p">[</span><span class="n">i_last_zero_offset_dot</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dist_to_prev</span> <span class="o">&lt;</span> <span class="n">jitter_thresh</span><span class="p">:</span>
            <span class="c1"># if this is the first of a set of offsets, save the sign of the initial offset</span>
            <span class="k">if</span> <span class="n">i_last_zero_offset_dot</span> <span class="o">==</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sign_of_initial_offset</span> <span class="o">=</span> <span class="n">sign_of_next_offset</span>
            <span class="c1"># set the offset of the current point</span>
            <span class="n">offsets</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="o">=</span> <span class="n">next_offset</span> <span class="o">*</span> <span class="n">sign_of_next_offset</span>
            <span class="c1"># if this offset was negative switch sign for next offset</span>
            <span class="k">if</span> <span class="n">sign_of_next_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">sign_of_next_offset</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">sign_of_initial_offset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">next_offset</span> <span class="o">=</span> <span class="n">next_offset</span> <span class="o">+</span> <span class="n">jitter_offset</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># otherwise switch sign and increase next offset</span>
                <span class="n">sign_of_next_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">sign_of_initial_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">next_offset</span> <span class="o">=</span> <span class="n">next_offset</span> <span class="o">+</span> <span class="n">jitter_offset</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if distance is not smaller than threshold do not offset</span>
            <span class="c1"># reset value and sign for next offset</span>
            <span class="n">next_offset</span> <span class="o">=</span> <span class="n">jitter_offset</span>
            <span class="c1"># update index for last y-value without offset (i.e. this one)</span>
            <span class="n">i_last_zero_offset_dot</span> <span class="o">=</span> <span class="n">d</span>

    <span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_value</span> <span class="o">+</span> <span class="n">offset</span> <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">offsets</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">x_values</span></div>


<div class="viewcode-block" id="arrow"><a class="viewcode-back" href="../p_plot.html#p_plot.arrow">[docs]</a><span class="k">def</span> <span class="nf">arrow</span><span class="p">(</span><span class="n">ax_handle</span><span class="p">,</span> <span class="n">base_xy</span><span class="p">,</span> <span class="n">tip_xy</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.13</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">head_width_factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">85</span><span class="p">,</span> <span class="o">.</span><span class="mi">85</span><span class="p">,</span> <span class="o">.</span><span class="mi">85</span><span class="p">),</span> <span class="n">bidirectional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot an arrow in axis ax_handle.</span>

<span class="sd">    :param ax_handle: Handle of the axis in which to plot the arrow</span>
<span class="sd">    :type ax_handle: matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">    :param base_xy: 2-element list/tuple of x- and y-coordinates of the arrow base</span>
<span class="sd">    :type base_xy: list or tuple</span>
<span class="sd">    :param tip_xy: 2-element list/tuple of x- and y-coordinates of the arrow tip</span>
<span class="sd">    :type tip_xy: list or tuple</span>
<span class="sd">    :param margin: shorten the arrow on both sides by margin</span>
<span class="sd">    :type margin: float</span>
<span class="sd">    :param width: width of the arrow tail (passed to plt.arrow())</span>
<span class="sd">    :type width: float</span>
<span class="sd">    :param head_length: length of the arrow head (passed to plt.arrow())</span>
<span class="sd">    :type head_length: float</span>
<span class="sd">    :param head_width_factor: arrow head width will be width * head_width_factor</span>
<span class="sd">    :type head_width_factor: float</span>
<span class="sd">    :param color: arrow color (passed to plt.arrow() as facecolor and edgecolor)</span>
<span class="sd">    :type color: list or str</span>
<span class="sd">    :param bidirectional: if true, arrow will have heads on both sides</span>
<span class="sd">    :type bidirectional: bool</span>
<span class="sd">    :param label: label for the arrow which will be displayed in the legend</span>
<span class="sd">    :type label: str</span>
<span class="sd">    :param clip_on: if False, portions of the arrow outside of the axis will be visible</span>
<span class="sd">    :type clip_on: bool</span>
<span class="sd">    :return:    - midpoint_xy: x- and y-coordinates of the arow midpoint (can be used e.g. for text annotations)</span>
<span class="sd">                - angle_deg: angle of the arrow in degrees</span>
<span class="sd">                - arrow_handle: handle of the arrow object (a FancyArrow object)</span>
<span class="sd">    :rtype:     - midpoint_xy: tuple</span>
<span class="sd">                - angle_deg: numpy.ndarray</span>
<span class="sd">                - arrow_handle: matplotlib.patches.FancyArrow</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arrow_len</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">pow</span><span class="p">(</span><span class="n">tip_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">pow</span><span class="p">(</span><span class="n">tip_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">sign_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">tip_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">tip_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">base_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="n">angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">base_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tip_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">base_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">tip_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># pre_y - post_y, pre_x - post_x</span>
    <span class="n">angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)</span>
    <span class="n">cos_angle_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">))</span>
    <span class="n">sin_angle_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">))</span>
    <span class="n">arrow_len_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">arrow_len</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">),</span> <span class="n">arrow_len</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angle_rad</span><span class="p">)])</span>
    <span class="n">arrow_len_abs_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">arrow_len_xy</span><span class="p">)</span>
    <span class="n">arrow_len_xy_shrink</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sign_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arrow_len_abs_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">*</span> <span class="n">cos_angle_abs</span><span class="p">),</span>
                                    <span class="n">sign_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">arrow_len_abs_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">*</span> <span class="n">sin_angle_abs</span><span class="p">)])</span>
    <span class="n">arrow_start_xy</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">*</span> <span class="n">cos_angle_abs</span><span class="p">,</span>
                      <span class="n">base_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sign_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">margin</span> <span class="o">*</span> <span class="n">sin_angle_abs</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">midpoint_xy</span> <span class="o">=</span> <span class="p">((</span><span class="n">base_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tip_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">base_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tip_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">arrow_start_xy</span> <span class="o">=</span> <span class="n">midpoint_xy</span>
        <span class="n">arrow_len_xy_shrink</span> <span class="o">=</span> <span class="n">arrow_len_xy_shrink</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">midpoint_xy</span> <span class="o">=</span> <span class="p">((</span><span class="n">base_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tip_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sign_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">head_length</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cos_angle_abs</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">base_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tip_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">sign_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">head_length</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sin_angle_abs</span><span class="p">)</span>
    <span class="n">arrow_handle</span> <span class="o">=</span> <span class="n">ax_handle</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">arrow_start_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrow_start_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arrow_len_xy_shrink</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrow_len_xy_shrink</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">head_length</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="n">head_width_factor</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span>
                                   <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="n">clip_on</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bidirectional</span><span class="p">:</span>
        <span class="n">ax_handle</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">arrow_start_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arrow_start_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">arrow_len_xy_shrink</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">arrow_len_xy_shrink</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">head_length</span><span class="o">=</span><span class="n">head_length</span><span class="p">,</span> <span class="n">head_width</span><span class="o">=</span><span class="n">head_width_factor</span> <span class="o">*</span> <span class="n">width</span><span class="p">,</span>
                        <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="n">clip_on</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">midpoint_xy</span><span class="p">,</span> <span class="n">angle_deg</span><span class="p">,</span> <span class="n">arrow_handle</span></div>


<div class="viewcode-block" id="abline"><a class="viewcode-back" href="../p_plot.html#p_plot.abline">[docs]</a><span class="k">def</span> <span class="nf">abline</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a line from slope and intercept&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
    <span class="n">y_vals</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_vals</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">handle</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019, Philipp Norton.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>